-- MatchVibe Database Schema - SAFE RERUN VERSION
-- Supabase PostgreSQL Setup
-- Version: 1.0.1
-- Last Updated: 2025-01-08
-- This script can be run multiple times safely

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create profiles table
CREATE TABLE IF NOT EXISTS profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  telegram_id BIGINT UNIQUE NOT NULL,
  username TEXT,
  first_name TEXT,
  last_name TEXT,
  avatar_url TEXT,
  premium_status BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create categories table
CREATE TABLE IF NOT EXISTS categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  description TEXT,
  icon TEXT,
  image_url TEXT,
  color TEXT,
  order_index INT DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create questions table
CREATE TABLE IF NOT EXISTS questions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  category_id UUID REFERENCES categories(id) ON DELETE CASCADE,
  text TEXT NOT NULL,
  image_url TEXT NOT NULL,
  order_index INT DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create rooms table
CREATE TABLE IF NOT EXISTS rooms (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  host_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  guest_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  status TEXT CHECK (status IN ('waiting', 'ready', 'playing', 'completed', 'cancelled')) DEFAULT 'waiting',
  invitation_code TEXT UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ
);

-- Create responses table
CREATE TABLE IF NOT EXISTS responses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  question_id UUID REFERENCES questions(id) ON DELETE CASCADE,
  answer SMALLINT CHECK (answer IN (0, 1)) NOT NULL, -- 0 = dislike, 1 = like
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(room_id, user_id, question_id)
);

-- Create results table
CREATE TABLE IF NOT EXISTS results (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  room_id UUID UNIQUE REFERENCES rooms(id) ON DELETE CASCADE,
  host_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  guest_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  match_percentage DECIMAL(5,2) NOT NULL,
  host_favorite TEXT,
  guest_favorite TEXT,
  shared_item TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create favorites table
CREATE TABLE IF NOT EXISTS favorites (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  item_name TEXT NOT NULL,
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  image_url TEXT,
  added_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, item_name, category_id)
);

-- Create achievements table
CREATE TABLE IF NOT EXISTS achievements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  description TEXT,
  icon TEXT,
  requirement INT NOT NULL,
  type TEXT CHECK (type IN ('games', 'matches', 'friends', 'compatibility')) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create user_achievements table
CREATE TABLE IF NOT EXISTS user_achievements (
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  achievement_id UUID REFERENCES achievements(id) ON DELETE CASCADE,
  unlocked_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (user_id, achievement_id)
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_profiles_telegram_id ON profiles(telegram_id);
CREATE INDEX IF NOT EXISTS idx_rooms_host_id ON rooms(host_id);
CREATE INDEX IF NOT EXISTS idx_rooms_guest_id ON rooms(guest_id);
CREATE INDEX IF NOT EXISTS idx_rooms_status ON rooms(status);
CREATE INDEX IF NOT EXISTS idx_rooms_invitation_code ON rooms(invitation_code);
CREATE INDEX IF NOT EXISTS idx_responses_room_id ON responses(room_id);
CREATE INDEX IF NOT EXISTS idx_responses_user_id ON responses(user_id);
CREATE INDEX IF NOT EXISTS idx_results_host_id ON results(host_id);
CREATE INDEX IF NOT EXISTS idx_results_guest_id ON results(guest_id);
CREATE INDEX IF NOT EXISTS idx_favorites_user_id ON favorites(user_id);
CREATE INDEX IF NOT EXISTS idx_questions_category_id ON questions(category_id);

-- Create updated_at trigger function (drop and recreate to avoid conflicts)
DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE;
CREATE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- Add trigger to profiles table (drop and recreate to avoid conflicts)
DROP TRIGGER IF EXISTS update_profiles_updated_at ON profiles;
CREATE TRIGGER update_profiles_updated_at 
BEFORE UPDATE ON profiles 
FOR EACH ROW 
EXECUTE FUNCTION update_updated_at_column();

-- Row Level Security (RLS) Policies
-- SIMPLIFIED FOR TELEGRAM MINI APP (No Supabase Auth)
-- Note: For production, consider implementing service role authentication

-- Enable RLS on all tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE responses ENABLE ROW LEVEL SECURITY;
ALTER TABLE results ENABLE ROW LEVEL SECURITY;
ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE achievements ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_achievements ENABLE ROW LEVEL SECURITY;

-- Drop existing policies to avoid conflicts
DROP POLICY IF EXISTS "Allow all operations on profiles" ON profiles;
DROP POLICY IF EXISTS "Allow all operations on rooms" ON rooms;
DROP POLICY IF EXISTS "Allow all operations on responses" ON responses;
DROP POLICY IF EXISTS "Allow all operations on results" ON results;
DROP POLICY IF EXISTS "Allow all operations on favorites" ON favorites;
DROP POLICY IF EXISTS "Categories are viewable by everyone" ON categories;
DROP POLICY IF EXISTS "Questions are viewable by everyone" ON questions;
DROP POLICY IF EXISTS "Achievements are viewable by everyone" ON achievements;
DROP POLICY IF EXISTS "Allow all operations on user_achievements" ON user_achievements;

-- Profiles: Allow all operations (Telegram validates on API level)
CREATE POLICY "Allow all operations on profiles"
  ON profiles
  USING (true)
  WITH CHECK (true);

-- Rooms: Allow all operations
CREATE POLICY "Allow all operations on rooms"
  ON rooms
  USING (true)
  WITH CHECK (true);

-- Responses: Allow all operations
CREATE POLICY "Allow all operations on responses"
  ON responses
  USING (true)
  WITH CHECK (true);

-- Results: Allow all operations
CREATE POLICY "Allow all operations on results"
  ON results
  USING (true)
  WITH CHECK (true);

-- Favorites: Allow all operations
CREATE POLICY "Allow all operations on favorites"
  ON favorites
  USING (true)
  WITH CHECK (true);

-- Categories: Public read-only
CREATE POLICY "Categories are viewable by everyone"
  ON categories FOR SELECT
  USING (is_active = TRUE);

-- Questions: Public read-only
CREATE POLICY "Questions are viewable by everyone"
  ON questions FOR SELECT
  USING (is_active = TRUE);

-- Achievements: Public read-only
CREATE POLICY "Achievements are viewable by everyone"
  ON achievements FOR SELECT
  USING (true);

-- User Achievements: Allow all operations (users can unlock achievements)
CREATE POLICY "Allow all operations on user_achievements"
  ON user_achievements
  USING (true)
  WITH CHECK (true);

-- Seed initial categories (ON CONFLICT DO NOTHING to avoid duplicates)
INSERT INTO categories (name, description, icon, color, order_index) VALUES
  ('–ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏', '–£–∑–Ω–∞–π—Ç–µ –≤–∞—à–∏ –æ–±—â–∏–µ –≤–∫—É—Å—ã –≤ –µ–¥–µ', 'üçï', 'hsl(25, 100%, 66%)', 1),
  ('–§–∏–ª—å–º—ã', '–ù–∞–π–¥–∏—Ç–µ –æ–±—â–∏–µ –ª—é–±–∏–º—ã–µ —Ñ–∏–ª—å–º—ã', 'üé¨', 'hsl(276, 100%, 70%)', 2),
  ('–ñ–∏–≤–æ—Ç–Ω—ã–µ', '–ö–æ–≥–æ –≤—ã –ª—é–±–∏—Ç–µ –±–æ–ª—å—à–µ?', 'üê∂', 'hsl(30, 100%, 74%)', 3),
  ('–û—Ç–Ω–æ—à–µ–Ω–∏—è', '–£–∑–Ω–∞–π—Ç–µ –æ –≤–∞–∂–Ω–æ–º –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö', 'üíû', 'hsl(345, 100%, 74%)', 4),
  ('–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', '–ö—É–¥–∞ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –ø–æ–µ—Ö–∞—Ç—å', 'üèñÔ∏è', 'hsl(210, 100%, 70%)', 5)
ON CONFLICT DO NOTHING;

-- Seed initial achievements (ON CONFLICT DO NOTHING to avoid duplicates)
INSERT INTO achievements (name, description, icon, requirement, type) VALUES
  ('–ü–µ—Ä–≤–∞—è –∏–≥—Ä–∞', '–°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É', 'üéØ', 1, 'games'),
  ('10 –∏–≥—Ä', '–°—ã–≥—Ä–∞–π—Ç–µ 10 –∏–≥—Ä', 'üî•', 10, 'games'),
  ('50 –∏–≥—Ä', '–°—ã–≥—Ä–∞–π—Ç–µ 50 –∏–≥—Ä', '‚≠ê', 50, 'games'),
  ('–ü–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ', '–ù–∞–π–¥–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ', 'üí´', 1, 'matches'),
  ('10 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π', '–ù–∞–π–¥–∏—Ç–µ 10 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π', '‚ú®', 10, 'matches'),
  ('–í—ã—Å–æ–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å', '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 80%+ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏', 'üíØ', 80, 'compatibility')
ON CONFLICT DO NOTHING;

-- Success message
DO $$
BEGIN
  RAISE NOTICE '‚úÖ Database schema created/updated successfully!';
  RAISE NOTICE 'Created tables: profiles, categories, questions, rooms, responses, results, favorites, achievements, user_achievements';
  RAISE NOTICE 'RLS policies configured for Telegram Mini App';
END $$;

-- MatchVibe Questions Seed Data
-- 12+ questions per category with images
-- Version: 1.0.0
-- Last Updated: 2025-01-08

-- Temporary variables to hold category IDs
DO $$
DECLARE
  food_cat_id UUID;
  movies_cat_id UUID;
  animals_cat_id UUID;
  relations_cat_id UUID;
  travel_cat_id UUID;
BEGIN
  -- Get category IDs
  SELECT id INTO food_cat_id FROM categories WHERE name = '–ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏';
  SELECT id INTO movies_cat_id FROM categories WHERE name = '–§–∏–ª—å–º—ã';
  SELECT id INTO animals_cat_id FROM categories WHERE name = '–ñ–∏–≤–æ—Ç–Ω—ã–µ';
  SELECT id INTO relations_cat_id FROM categories WHERE name = '–û—Ç–Ω–æ—à–µ–Ω–∏—è';
  SELECT id INTO travel_cat_id FROM categories WHERE name = '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è';

  -- ========================================
  -- CATEGORY 1: –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ (Food & Drinks)
  -- ========================================
  INSERT INTO questions (category_id, text, image_url, order_index) VALUES
    (food_cat_id, '–ü–∏—Ü—Ü–∞', 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=400&fit=crop', 1),
    (food_cat_id, '–°—É—à–∏', 'https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=400&h=400&fit=crop', 2),
    (food_cat_id, '–ë—É—Ä–≥–µ—Ä—ã', 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&h=400&fit=crop', 3),
    (food_cat_id, '–ü–∞—Å—Ç–∞', 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?w=400&h=400&fit=crop', 4),
    (food_cat_id, '–°—Ç–µ–π–∫', 'https://images.unsplash.com/photo-1588168333986-5078d3ae3976?w=400&h=400&fit=crop', 5),
    (food_cat_id, '–®–æ–∫–æ–ª–∞–¥', 'https://images.unsplash.com/photo-1511381939415-e44015466834?w=400&h=400&fit=crop', 6),
    (food_cat_id, '–ú–æ—Ä–æ–∂–µ–Ω–æ–µ', 'https://images.unsplash.com/photo-1563805042-7684c019e1cb?w=400&h=400&fit=crop', 7),
    (food_cat_id, '–ö–æ—Ñ–µ', 'https://images.unsplash.com/photo-1511920170033-f8396924c348?w=400&h=400&fit=crop', 8),
    (food_cat_id, '–ß–∞–π', 'https://images.unsplash.com/photo-1564890369478-c89ca6d9cde9?w=400&h=400&fit=crop', 9),
    (food_cat_id, '–í–∏–Ω–æ', 'https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?w=400&h=400&fit=crop', 10),
    (food_cat_id, '–ü–∏–≤–æ', 'https://images.unsplash.com/photo-1608270586620-248524c67de9?w=400&h=400&fit=crop', 11),
    (food_cat_id, '–ö–æ–∫—Ç–µ–π–ª–∏', 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400&h=400&fit=crop', 12),
    (food_cat_id, '–¢–æ—Ä—Ç—ã', 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=400&fit=crop', 13),
    (food_cat_id, '–§—Ä—É–∫—Ç—ã', 'https://images.unsplash.com/photo-1619566636858-adf3ef46400b?w=400&h=400&fit=crop', 14),
    (food_cat_id, '–û–≤–æ—â–∏', 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=400&fit=crop', 15)
  ON CONFLICT DO NOTHING;

  -- ========================================
  -- CATEGORY 2: –§–∏–ª—å–º—ã (Movies)
  -- ========================================
  INSERT INTO questions (category_id, text, image_url, order_index) VALUES
    (movies_cat_id, '–ö–æ–º–µ–¥–∏–∏', 'https://images.unsplash.com/photo-1594908900066-3f47337549d8?w=400&h=400&fit=crop', 1),
    (movies_cat_id, '–ë–æ–µ–≤–∏–∫–∏', 'https://images.unsplash.com/photo-1536440136628-849c177e76a1?w=400&h=400&fit=crop', 2),
    (movies_cat_id, '–†–æ–º–∞–Ω—Ç–∏–∫–∞', 'https://images.unsplash.com/photo-1518676590629-3dcbd9c5a5c9?w=400&h=400&fit=crop', 3),
    (movies_cat_id, '–£–∂–∞—Å—ã', 'https://images.unsplash.com/photo-1509248961158-e54f6934749c?w=400&h=400&fit=crop', 4),
    (movies_cat_id, '–ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', 'https://images.unsplash.com/photo-1635805737707-575885ab0820?w=400&h=400&fit=crop', 5),
    (movies_cat_id, '–§—ç–Ω—Ç–µ–∑–∏', 'https://images.unsplash.com/photo-1518676590629-3dcbd9c5a5c9?w=400&h=400&fit=crop', 6),
    (movies_cat_id, '–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ', 'https://images.unsplash.com/photo-1478720568477-152d9b164e26?w=400&h=400&fit=crop', 7),
    (movies_cat_id, '–î—Ä–∞–º–∞', 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=400&fit=crop', 8),
    (movies_cat_id, '–¢—Ä–∏–ª–ª–µ—Ä—ã', 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?w=400&h=400&fit=crop', 9),
    (movies_cat_id, '–ê–Ω–∏–º–∞—Ü–∏—è', 'https://images.unsplash.com/photo-1536440136628-849c177e76a1?w=400&h=400&fit=crop', 10),
    (movies_cat_id, '–î–µ—Ç–µ–∫—Ç–∏–≤—ã', 'https://images.unsplash.com/photo-1560109947-543149eceb16?w=400&h=400&fit=crop', 11),
    (movies_cat_id, '–ú—é–∑–∏–∫–ª—ã', 'https://images.unsplash.com/photo-1507676184212-d03ab07a01bf?w=400&h=400&fit=crop', 12),
    (movies_cat_id, '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è', 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=400&fit=crop', 13),
    (movies_cat_id, '–ë–∏–æ–≥—Ä–∞—Ñ–∏–∏', 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?w=400&h=400&fit=crop', 14),
    (movies_cat_id, '–ê—Ä—Ç—Ö–∞—É—Å', 'https://images.unsplash.com/photo-1478720568477-152d9b164e26?w=400&h=400&fit=crop', 15)
  ON CONFLICT DO NOTHING;

  -- ========================================
  -- CATEGORY 3: –ñ–∏–≤–æ—Ç–Ω—ã–µ (Animals)
  -- ========================================
  INSERT INTO questions (category_id, text, image_url, order_index) VALUES
    (animals_cat_id, '–°–æ–±–∞–∫–∏', 'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=400&h=400&fit=crop', 1),
    (animals_cat_id, '–ö–æ—à–∫–∏', 'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=400&h=400&fit=crop', 2),
    (animals_cat_id, '–ü—Ç–∏—Ü—ã', 'https://images.unsplash.com/photo-1552728089-57bdde30beb3?w=400&h=400&fit=crop', 3),
    (animals_cat_id, '–†—ã–±–∫–∏', 'https://images.unsplash.com/photo-1520990269612-c18a49fa3c3e?w=400&h=400&fit=crop', 4),
    (animals_cat_id, '–õ–æ—à–∞–¥–∏', 'https://images.unsplash.com/photo-1553284965-83fd3e82fa5a?w=400&h=400&fit=crop', 5),
    (animals_cat_id, '–ö—Ä–æ–ª–∏–∫–∏', 'https://images.unsplash.com/photo-1585110396000-c9ffd4e4b308?w=400&h=400&fit=crop', 6),
    (animals_cat_id, '–•–æ–º—è–∫–∏', 'https://images.unsplash.com/photo-1548767797-d8c844163c4c?w=400&h=400&fit=crop', 7),
    (animals_cat_id, '–ß–µ—Ä–µ–ø–∞—Ö–∏', 'https://images.unsplash.com/photo-1437622368342-7a3d73a34c8f?w=400&h=400&fit=crop', 8),
    (animals_cat_id, '–ó–º–µ–∏', 'https://images.unsplash.com/photo-1531386151447-fd76ad50012f?w=400&h=400&fit=crop', 9),
    (animals_cat_id, '–ü–∞–Ω–¥—ã', 'https://images.unsplash.com/photo-1564349683136-77e08dba1ef7?w=400&h=400&fit=crop', 10),
    (animals_cat_id, '–¢–∏–≥—Ä—ã', 'https://images.unsplash.com/photo-1561731216-c3a4d99437d5?w=400&h=400&fit=crop', 11),
    (animals_cat_id, '–î–µ–ª—å—Ñ–∏–Ω—ã', 'https://images.unsplash.com/photo-1570481662006-a3a1374699e8?w=400&h=400&fit=crop', 12),
    (animals_cat_id, '–°–ª–æ–Ω—ã', 'https://images.unsplash.com/photo-1564760055775-d63b17a55c44?w=400&h=400&fit=crop', 13),
    (animals_cat_id, '–ñ–∏—Ä–∞—Ñ—ã', 'https://images.unsplash.com/photo-1547721064-da6cfb341d50?w=400&h=400&fit=crop', 14),
    (animals_cat_id, '–ü–∏–Ω–≥–≤–∏–Ω—ã', 'https://images.unsplash.com/photo-1551986782-d0169b3f8fa7?w=400&h=400&fit=crop', 15)
  ON CONFLICT DO NOTHING;

  -- ========================================
  -- CATEGORY 4: –û—Ç–Ω–æ—à–µ–Ω–∏—è (Relationships)
  -- ========================================
  INSERT INTO questions (category_id, text, image_url, order_index) VALUES
    (relations_cat_id, '–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —É–∂–∏–Ω—ã', 'https://images.unsplash.com/photo-1481833761820-0509d3217039?w=400&h=400&fit=crop', 1),
    (relations_cat_id, '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –≤–º–µ—Å—Ç–µ', 'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=400&h=400&fit=crop', 2),
    (relations_cat_id, '–î–æ–≤–µ—Ä–∏–µ', 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b2?w=400&h=400&fit=crop', 3),
    (relations_cat_id, '–û–±—â–∏–µ —Ö–æ–±–±–∏', 'https://images.unsplash.com/photo-1511988617509-a57c8a288659?w=400&h=400&fit=crop', 4),
    (relations_cat_id, '–°—é—Ä–ø—Ä–∏–∑—ã', 'https://images.unsplash.com/photo-1513885535751-8b9238bd345a?w=400&h=400&fit=crop', 5),
    (relations_cat_id, '–û—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã', 'https://images.unsplash.com/photo-1521791055366-0d553872125f?w=400&h=400&fit=crop', 6),
    (relations_cat_id, '–°–æ–≤–º–µ—Å—Ç–Ω—ã–π –æ—Ç–¥—ã—Ö', 'https://images.unsplash.com/photo-1523438097201-512ae7d59c44?w=400&h=400&fit=crop', 7),
    (relations_cat_id, '–ü–æ–¥–¥–µ—Ä–∂–∫–∞', 'https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?w=400&h=400&fit=crop', 8),
    (relations_cat_id, '–Æ–º–æ—Ä', 'https://images.unsplash.com/photo-1555421689-d68471e189f2?w=400&h=400&fit=crop', 9),
    (relations_cat_id, '–õ–∏—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ', 'https://images.unsplash.com/photo-1524678606370-a47ad25cb82a?w=400&h=400&fit=crop', 10),
    (relations_cat_id, '–û–±—â–∏–µ —Ü–µ–ª–∏', 'https://images.unsplash.com/photo-1512428559087-560fa5ceab42?w=400&h=400&fit=crop', 11),
    (relations_cat_id, '–°–µ–º–µ–π–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏', 'https://images.unsplash.com/photo-1511895426328-dc8714191300?w=400&h=400&fit=crop', 12),
    (relations_cat_id, '–°–ø–æ–Ω—Ç–∞–Ω–Ω–æ—Å—Ç—å', 'https://images.unsplash.com/photo-1533577116850-9cc66cad8a9b?w=400&h=400&fit=crop', 13),
    (relations_cat_id, '–†–æ–º–∞–Ω—Ç–∏–∫–∞', 'https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?w=400&h=400&fit=crop', 14),
    (relations_cat_id, '–í–µ—Ä–Ω–æ—Å—Ç—å', 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=400&h=400&fit=crop', 15)
  ON CONFLICT DO NOTHING;

  -- ========================================
  -- CATEGORY 5: –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è (Travel)
  -- ========================================
  INSERT INTO questions (category_id, text, image_url, order_index) VALUES
    (travel_cat_id, '–ü–ª—è–∂–Ω—ã–π –æ—Ç–¥—ã—Ö', 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400&h=400&fit=crop', 1),
    (travel_cat_id, '–ì–æ—Ä–Ω–æ–ª—ã–∂–Ω—ã–µ –∫—É—Ä–æ—Ä—Ç—ã', 'https://images.unsplash.com/photo-1551524164-687a55dd1126?w=400&h=400&fit=crop', 2),
    (travel_cat_id, '–ì–æ—Ä–æ–¥–∞ –ï–≤—Ä–æ–ø—ã', 'https://images.unsplash.com/photo-1467269204594-9661b134dd2b?w=400&h=400&fit=crop', 3),
    (travel_cat_id, '–≠–∫–∑–æ—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã', 'https://images.unsplash.com/photo-1537996194471-e657df975ab4?w=400&h=400&fit=crop', 4),
    (travel_cat_id, '–î–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞', 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=400&fit=crop', 5),
    (travel_cat_id, '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –º–µ—Å—Ç–∞', 'https://images.unsplash.com/photo-1513581166391-887a96ddeafd?w=400&h=400&fit=crop', 6),
    (travel_cat_id, '–ú–µ–≥–∞–ø–æ–ª–∏—Å—ã', 'https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?w=400&h=400&fit=crop', 7),
    (travel_cat_id, '–ö—Ä—É–∏–∑—ã', 'https://images.unsplash.com/photo-1520250497591-112f2f40a3f4?w=400&h=400&fit=crop', 8),
    (travel_cat_id, '–ö–µ–º–ø–∏–Ω–≥', 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=400&h=400&fit=crop', 9),
    (travel_cat_id, '–†–æ—Å–∫–æ—à–Ω—ã–µ –æ—Ç–µ–ª–∏', 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=400&fit=crop', 10),
    (travel_cat_id, '–°–∞—Ñ–∞—Ä–∏', 'https://images.unsplash.com/photo-1516426122078-c23e76319801?w=400&h=400&fit=crop', 11),
    (travel_cat_id, '–û—Å—Ç—Ä–æ–≤–Ω—ã–µ –∫—É—Ä–æ—Ä—Ç—ã', 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=400&h=400&fit=crop', 12),
    (travel_cat_id, '–ì–æ—Ä–Ω—ã–µ –ø–æ—Ö–æ–¥—ã', 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=400&h=400&fit=crop', 13),
    (travel_cat_id, '–ö—É–ª—å—Ç—É—Ä–Ω—ã–µ —Ç—É—Ä—ã', 'https://images.unsplash.com/photo-1533929736458-ca588d08c8be?w=400&h=400&fit=crop', 14),
    (travel_cat_id, '–ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Ç—É—Ä—ã', 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&h=400&fit=crop', 15)
  ON CONFLICT DO NOTHING;

  RAISE NOTICE '‚úÖ Questions seed data inserted successfully!';
  RAISE NOTICE 'Total: 75 questions (15 per category √ó 5 categories)';
END $$;

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE responses ENABLE ROW LEVEL SECURITY;
ALTER TABLE results ENABLE ROW LEVEL SECURITY;
ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE achievements ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_achievements ENABLE ROW LEVEL SECURITY;

SELECT 
  'Categories' as table_name,
  COUNT(*) as count
FROM categories
UNION ALL
SELECT 
  'Questions' as table_name,
  COUNT(*) as count
FROM questions;

-- Subcategories Migration for MatchVibe
-- Adds subcategory structure to existing categories
-- Version: 1.0.0
-- Date: 2025-01-09

-- ========================================
-- 1. Create Subcategories Table
-- ========================================

CREATE TABLE IF NOT EXISTS subcategories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  category_id UUID NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  icon TEXT,
  order_index INTEGER NOT NULL DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Add index for faster lookups
CREATE INDEX IF NOT EXISTS idx_subcategories_category 
ON subcategories(category_id, is_active, order_index);

-- Enable RLS
ALTER TABLE subcategories ENABLE ROW LEVEL SECURITY;

-- RLS Policy: Anyone can view active subcategories
DROP POLICY IF EXISTS "Subcategories are viewable by everyone" ON subcategories;
CREATE POLICY "Subcategories are viewable by everyone"
  ON subcategories FOR SELECT
  USING (is_active = TRUE);

-- ========================================
-- 2. Update Questions Table
-- ========================================

-- Add subcategory_id column to questions
ALTER TABLE questions 
ADD COLUMN IF NOT EXISTS subcategory_id UUID REFERENCES subcategories(id) ON DELETE SET NULL;

-- Create index for subcategory lookups
CREATE INDEX IF NOT EXISTS idx_questions_subcategory 
ON questions(subcategory_id);

-- ========================================
-- 3. Clean up existing duplicates
-- ========================================

-- Delete duplicate subcategories, keeping only the first one
DELETE FROM subcategories
WHERE id NOT IN (
  SELECT MIN(id)
  FROM subcategories
  GROUP BY category_id, name
);

-- Now create unique constraint to prevent future duplicates
DROP INDEX IF EXISTS idx_subcategories_unique;
CREATE UNIQUE INDEX idx_subcategories_unique 
ON subcategories(category_id, name) WHERE is_active = TRUE;

-- ========================================
-- 4. Insert Subcategories Data
-- ========================================

DO $$
DECLARE
  food_cat_id UUID;
  entertainment_cat_id UUID;
  animals_cat_id UUID;
  relationships_cat_id UUID;
  leisure_cat_id UUID;
  perception_cat_id UUID;
  misc_cat_id UUID;
BEGIN
  -- Get existing category IDs by icon (more reliable than name)
  SELECT id INTO food_cat_id FROM categories WHERE icon = 'üçï' LIMIT 1;
  SELECT id INTO entertainment_cat_id FROM categories WHERE icon = 'üé¨' LIMIT 1;
  SELECT id INTO animals_cat_id FROM categories WHERE icon = 'üê∂' LIMIT 1;
  SELECT id INTO relationships_cat_id FROM categories WHERE icon = 'üíû' LIMIT 1;
  SELECT id INTO leisure_cat_id FROM categories WHERE icon = 'üèñÔ∏è' LIMIT 1;
  
  -- Try to find by name if icon search failed
  IF food_cat_id IS NULL THEN
    SELECT id INTO food_cat_id FROM categories WHERE name ILIKE '%–µ–¥–∞%' OR name ILIKE '%food%' LIMIT 1;
  END IF;
  
  IF entertainment_cat_id IS NULL THEN
    SELECT id INTO entertainment_cat_id FROM categories WHERE name ILIKE '%—Ä–∞–∑–≤–ª–µ—á–µ–Ω%' OR name ILIKE '%—Ñ–∏–ª—å–º%' LIMIT 1;
  END IF;
  
  IF animals_cat_id IS NULL THEN
    SELECT id INTO animals_cat_id FROM categories WHERE name ILIKE '%–∂–∏–≤–æ—Ç–Ω%' OR name ILIKE '%animal%' LIMIT 1;
  END IF;
  
  IF relationships_cat_id IS NULL THEN
    SELECT id INTO relationships_cat_id FROM categories WHERE name ILIKE '%–æ—Ç–Ω–æ—à–µ–Ω%' OR name ILIKE '%–ª–∏—á–Ω–æ—Å—Ç%' LIMIT 1;
  END IF;
  
  IF leisure_cat_id IS NULL THEN
    SELECT id INTO leisure_cat_id FROM categories WHERE name ILIKE '%–¥–æ—Å—É–≥%' OR name ILIKE '%–ø—É—Ç–µ—à–µ—Å—Ç–≤%' LIMIT 1;
  END IF;
  
  -- If still not found, raise notice
  IF food_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Food category not found! Please create it first.';
  END IF;
  
  IF entertainment_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Entertainment category not found! Please create it first.';
  END IF;
  
  IF animals_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Animals category not found! Please create it first.';
  END IF;
  
  IF relationships_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Relationships category not found! Please create it first.';
  END IF;
  
  IF leisure_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Leisure category not found! Please create it first.';
  END IF;

  -- Insert Subcategories (only if category exists)

  -- üçï –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏
  IF food_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) VALUES
      (food_cat_id, '–õ—é–±–∏–º–∞—è –∫—É—Ö–Ω—è', 1),
      (food_cat_id, '–õ—é–±–∏–º–æ–µ –±–ª—é–¥–æ', 2),
      (food_cat_id, '–ö–æ—Ñ–µ / —á–∞–π', 3),
      (food_cat_id, '–î–µ—Å–µ—Ä—Ç—ã', 4),
      (food_cat_id, '–£–ª–∏—á–Ω–∞—è –µ–¥–∞', 5),
      (food_cat_id, '–ó–∞–≤—Ç—Ä–∞–∫ –º–µ—á—Ç—ã', 6),
      (food_cat_id, '–†–µ—Å—Ç–æ—Ä–∞–Ω –º–µ—á—Ç—ã', 7)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ Food subcategories created';
  END IF;

  -- üé¨ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞
  IF entertainment_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) VALUES
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π —Ñ–∏–ª—å–º', 1),
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä –∫–∏–Ω–æ', 2),
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', 3),
      (entertainment_cat_id, '–õ—é–±–∏–º–∞—è –ø–µ—Å–Ω—è', 4),
      (entertainment_cat_id, '–°–µ—Ä–∏–∞–ª, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å', 5),
      (entertainment_cat_id, '–õ—é–±–∏–º–∞—è –∏–≥—Ä–∞ (–Ω–∞—Å—Ç–æ–ª—å–Ω–∞—è / –≤–∏–¥–µ–æ–∏–≥—Ä–∞)', 6),
      (entertainment_cat_id, '–°–∞–º—ã–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π —Ñ–∏–ª—å–º', 7)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ Entertainment subcategories created';
  END IF;

  -- üê∂ –ñ–∏–≤–æ—Ç–Ω—ã–µ
  IF animals_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) VALUES
      (animals_cat_id, '–õ—é–±–∏–º–∞—è –ø–æ—Ä–æ–¥–∞ —Å–æ–±–∞–∫', 1),
      (animals_cat_id, '–ö–æ—à–∫–∏ vs —Å–æ–±–∞–∫–∏', 2),
      (animals_cat_id, '–ò–¥–µ–∞–ª—å–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü', 3),
      (animals_cat_id, '–î–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞ –∏–ª–∏ –¥–æ–º–∞—à–Ω–∏–µ –ª—é–±–∏–º—Ü—ã', 4)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ Animals subcategories created';
  END IF;

  -- üíû –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª–∏—á–Ω–æ—Å—Ç—å
  IF relationships_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) VALUES
      (relationships_cat_id, '–ì–ª–∞–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ —á–µ–ª–æ–≤–µ–∫–µ', 1),
      (relationships_cat_id, '–ì–ª–∞–≤–Ω—ã–π —Å—Ç—Ä–∞—Ö', 2),
      (relationships_cat_id, '–ó–∞–≤–µ—Ç–Ω–∞—è –º–µ—á—Ç–∞', 3),
      (relationships_cat_id, '–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –¥—Ä—É–∂–±–µ', 4),
      (relationships_cat_id, '–ö–∞–∫ —Ç—ã –ø—Ä–æ—è–≤–ª—è–µ—à—å –∑–∞–±–æ—Ç—É', 5),
      (relationships_cat_id, '–õ—é–±–∏–º—ã–π —Ç–∏–ø –æ—Ç–¥—ã—Ö–∞ –≤–¥–≤–æ–µ–º', 6)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ Relationships subcategories created';
  END IF;

  -- üèñÔ∏è –î–æ—Å—É–≥ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
  IF leisure_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) VALUES
      (leisure_cat_id, '–õ—é–±–∏–º–æ–µ –º–µ—Å—Ç–æ –æ—Ç–¥—ã—Ö–∞', 1),
      (leisure_cat_id, '–ò–¥–µ–∞–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', 2),
      (leisure_cat_id, '–ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö –∏–ª–∏ —Ä–µ–ª–∞–∫—Å', 3),
      (leisure_cat_id, '–ì–æ—Ä–æ–¥ –º–µ—á—Ç—ã', 4),
      (leisure_cat_id, '–ò–¥–µ–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π', 5)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ Leisure subcategories created';
  END IF;

  RAISE NOTICE '‚úÖ Subcategories created successfully!';
END $$;

-- ========================================
-- 5. Verification
-- ========================================

-- Check subcategories count
DO $$
DECLARE
  subcat_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO subcat_count FROM subcategories;
  RAISE NOTICE 'Total subcategories: %', subcat_count;
END $$;

-- Show subcategories grouped by category
SELECT 
  c.name as category_name,
  c.icon as category_icon,
  COUNT(sc.id) as subcategory_count
FROM categories c
LEFT JOIN subcategories sc ON sc.category_id = c.id
GROUP BY c.id, c.name, c.icon, c.order_index
ORDER BY c.order_index;

-- ========================================
-- FIX CATEGORY DUPLICATES - FINAL SOLUTION
-- ========================================
-- –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
-- 1. –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
-- 2. –û—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –∫–∞–∂–¥—ã–º emoji
-- 3. –û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
-- 4. –ü–µ—Ä–µ–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
-- ========================================

BEGIN;

-- ========================================
-- –®–ê–ì 1: –ù–∞–π—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ (—Ç–µ —á—Ç–æ –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å)
-- ========================================

DO $$
DECLARE
  -- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å (—Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
  food_keep_id UUID;
  entertainment_keep_id UUID;
  animals_keep_id UUID;
  relationships_keep_id UUID;
  leisure_keep_id UUID;
  perception_keep_id UUID;
  misc_keep_id UUID;
  
  -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞
  deleted_count INTEGER := 0;
BEGIN
  
  RAISE NOTICE '==============================================';
  RAISE NOTICE 'FIXING CATEGORY DUPLICATES';
  RAISE NOTICE '==============================================';
  
  -- ========================================
  -- –®–ê–ì 2: –ù–∞–π—Ç–∏ "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ" –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏)
  -- ========================================
  
  -- üçï –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏
  SELECT c.id INTO food_keep_id
  FROM categories c
  LEFT JOIN subcategories sc ON sc.category_id = c.id
  WHERE c.icon = 'üçï'
  GROUP BY c.id
  HAVING COUNT(sc.id) > 0
  LIMIT 1;
  
  -- üé¨ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞
  SELECT c.id INTO entertainment_keep_id
  FROM categories c
  LEFT JOIN subcategories sc ON sc.category_id = c.id
  WHERE c.icon = 'üé¨'
  GROUP BY c.id
  HAVING COUNT(sc.id) > 0
  LIMIT 1;
  
  -- üê∂ –ñ–∏–≤–æ—Ç–Ω—ã–µ
  SELECT c.id INTO animals_keep_id
  FROM categories c
  LEFT JOIN subcategories sc ON sc.category_id = c.id
  WHERE c.icon = 'üê∂'
  GROUP BY c.id
  HAVING COUNT(sc.id) > 0
  LIMIT 1;
  
  -- üíû –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª–∏—á–Ω–æ—Å—Ç—å
  SELECT c.id INTO relationships_keep_id
  FROM categories c
  LEFT JOIN subcategories sc ON sc.category_id = c.id
  WHERE c.icon = 'üíû'
  GROUP BY c.id
  HAVING COUNT(sc.id) > 0
  LIMIT 1;
  
  -- üèñÔ∏è –î–æ—Å—É–≥ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
  SELECT c.id INTO leisure_keep_id
  FROM categories c
  LEFT JOIN subcategories sc ON sc.category_id = c.id
  WHERE c.icon = 'üèñÔ∏è'
  GROUP BY c.id
  HAVING COUNT(sc.id) > 0
  LIMIT 1;
  
  -- üí° –õ–∏—á–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ (–æ–±—ã—á–Ω–æ –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º)
  SELECT c.id INTO perception_keep_id
  FROM categories c
  WHERE c.icon = 'üí°'
  LIMIT 1;
  
  -- üéÅ –†–∞–∑–Ω–æ–µ –∏ –≤–µ—Å—ë–ª–æ–µ (–æ–±—ã—á–Ω–æ –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º)
  SELECT c.id INTO misc_keep_id
  FROM categories c
  WHERE c.icon = 'üéÅ'
  LIMIT 1;
  
  RAISE NOTICE '';
  RAISE NOTICE 'Found categories to keep:';
  RAISE NOTICE '  üçï Food: %', food_keep_id;
  RAISE NOTICE '  üé¨ Entertainment: %', entertainment_keep_id;
  RAISE NOTICE '  üê∂ Animals: %', animals_keep_id;
  RAISE NOTICE '  üíû Relationships: %', relationships_keep_id;
  RAISE NOTICE '  üèñÔ∏è Leisure: %', leisure_keep_id;
  RAISE NOTICE '  üí° Perception: %', perception_keep_id;
  RAISE NOTICE '  üéÅ Misc: %', misc_keep_id;
  RAISE NOTICE '';
  
  -- ========================================
  -- –®–ê–ì 3: –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è "–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  -- ========================================
  
  RAISE NOTICE 'Updating category names...';
  
  IF food_keep_id IS NOT NULL THEN
    UPDATE categories SET name = '–ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏' WHERE id = food_keep_id;
    RAISE NOTICE '  ‚úÖ Updated: –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏';
  END IF;
  
  IF entertainment_keep_id IS NOT NULL THEN
    UPDATE categories SET name = '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞' WHERE id = entertainment_keep_id;
    RAISE NOTICE '  ‚úÖ Updated: –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞';
  END IF;
  
  IF animals_keep_id IS NOT NULL THEN
    UPDATE categories SET name = '–ñ–∏–≤–æ—Ç–Ω—ã–µ' WHERE id = animals_keep_id;
    RAISE NOTICE '  ‚úÖ Updated: –ñ–∏–≤–æ—Ç–Ω—ã–µ';
  END IF;
  
  IF relationships_keep_id IS NOT NULL THEN
    UPDATE categories SET name = '–û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª–∏—á–Ω–æ—Å—Ç—å' WHERE id = relationships_keep_id;
    RAISE NOTICE '  ‚úÖ Updated: –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª–∏—á–Ω–æ—Å—Ç—å';
  END IF;
  
  IF leisure_keep_id IS NOT NULL THEN
    UPDATE categories SET name = '–î–æ—Å—É–≥ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è' WHERE id = leisure_keep_id;
    RAISE NOTICE '  ‚úÖ Updated: –î–æ—Å—É–≥ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è';
  END IF;
  
  IF perception_keep_id IS NOT NULL THEN
    UPDATE categories SET name = '–õ–∏—á–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ' WHERE id = perception_keep_id;
    RAISE NOTICE '  ‚úÖ Updated: –õ–∏—á–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ';
  END IF;
  
  IF misc_keep_id IS NOT NULL THEN
    UPDATE categories SET name = '–†–∞–∑–Ω–æ–µ –∏ –≤–µ—Å—ë–ª–æ–µ' WHERE id = misc_keep_id;
    RAISE NOTICE '  ‚úÖ Updated: –†–∞–∑–Ω–æ–µ –∏ –≤–µ—Å—ë–ª–æ–µ';
  END IF;
  
  RAISE NOTICE '';
  
  -- ========================================
  -- –®–ê–ì 4: –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  -- ========================================
  
  RAISE NOTICE 'Deleting duplicate categories...';
  
  -- –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å emoji üçï –∫—Ä–æ–º–µ —Ç–æ–π, –∫–æ—Ç–æ—Ä—É—é –æ—Å—Ç–∞–≤–ª—è–µ–º
  IF food_keep_id IS NOT NULL THEN
    DELETE FROM categories WHERE icon = 'üçï' AND id != food_keep_id;
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RAISE NOTICE '  üçï Deleted % duplicates', deleted_count;
  END IF;
  
  -- –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å emoji üé¨ –∫—Ä–æ–º–µ —Ç–æ–π, –∫–æ—Ç–æ—Ä—É—é –æ—Å—Ç–∞–≤–ª—è–µ–º
  IF entertainment_keep_id IS NOT NULL THEN
    DELETE FROM categories WHERE icon = 'üé¨' AND id != entertainment_keep_id;
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RAISE NOTICE '  üé¨ Deleted % duplicates', deleted_count;
  END IF;
  
  -- –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å emoji üê∂ –∫—Ä–æ–º–µ —Ç–æ–π, –∫–æ—Ç–æ—Ä—É—é –æ—Å—Ç–∞–≤–ª—è–µ–º
  IF animals_keep_id IS NOT NULL THEN
    DELETE FROM categories WHERE icon = 'üê∂' AND id != animals_keep_id;
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RAISE NOTICE '  üê∂ Deleted % duplicates', deleted_count;
  END IF;
  
  -- –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å emoji üíû –∫—Ä–æ–º–µ —Ç–æ–π, –∫–æ—Ç–æ—Ä—É—é –æ—Å—Ç–∞–≤–ª—è–µ–º
  IF relationships_keep_id IS NOT NULL THEN
    DELETE FROM categories WHERE icon = 'üíû' AND id != relationships_keep_id;
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RAISE NOTICE '  üíû Deleted % duplicates', deleted_count;
  END IF;
  
  -- –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å emoji üèñÔ∏è –∫—Ä–æ–º–µ —Ç–æ–π, –∫–æ—Ç–æ—Ä—É—é –æ—Å—Ç–∞–≤–ª—è–µ–º
  IF leisure_keep_id IS NOT NULL THEN
    DELETE FROM categories WHERE icon = 'üèñÔ∏è' AND id != leisure_keep_id;
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RAISE NOTICE '  üèñÔ∏è Deleted % duplicates', deleted_count;
  END IF;
  
  RAISE NOTICE '';
  RAISE NOTICE '‚úÖ DUPLICATES REMOVED SUCCESSFULLY!';
  RAISE NOTICE '';
  
END $$;

-- ========================================
-- –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
-- ========================================

DO $$
DECLARE
  total_categories INTEGER;
  total_subcategories INTEGER;
BEGIN
  SELECT COUNT(*) INTO total_categories FROM categories WHERE is_active = TRUE;
  SELECT COUNT(*) INTO total_subcategories FROM subcategories WHERE is_active = TRUE;
  
  RAISE NOTICE '==============================================';
  RAISE NOTICE 'VERIFICATION';
  RAISE NOTICE '==============================================';
  RAISE NOTICE 'Total active categories: %', total_categories;
  RAISE NOTICE 'Total active subcategories: %', total_subcategories;
  RAISE NOTICE '';
END $$;

-- –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT 
  c.name as category_name,
  c.icon as category_icon,
  c.order_index,
  COUNT(sc.id) as subcategory_count
FROM categories c
LEFT JOIN subcategories sc ON sc.category_id = c.id
WHERE c.is_active = TRUE
GROUP BY c.id, c.name, c.icon, c.order_index
ORDER BY c.order_index;

COMMIT;

-- ========================================
-- –ì–û–¢–û–í–û!
-- ========================================
-- 
-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- ‚úÖ –¢–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (7 —à—Ç—É–∫)
-- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
-- ‚úÖ –í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã
-- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
-- 
-- ========================================


-- ============================================================
-- Subcategories Migration for MatchVibe
-- ============================================================
-- Adds subcategory structure to existing categories
-- Version: 2.0.0 (FIXED)
-- Date: 2025-01-09
-- Fix: Corrected UUID duplicate deletion method
-- ============================================================

-- ========================================
-- 1. Create Subcategories Table
-- ========================================

CREATE TABLE IF NOT EXISTS subcategories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  category_id UUID NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  icon TEXT,
  order_index INTEGER NOT NULL DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Add index for faster lookups
CREATE INDEX IF NOT EXISTS idx_subcategories_category 
ON subcategories(category_id, is_active, order_index);

-- Enable RLS
ALTER TABLE subcategories ENABLE ROW LEVEL SECURITY;

-- RLS Policy: Anyone can view active subcategories
DROP POLICY IF EXISTS "Subcategories are viewable by everyone" ON subcategories;
CREATE POLICY "Subcategories are viewable by everyone"
  ON subcategories FOR SELECT
  USING (is_active = TRUE);

-- ========================================
-- 2. Update Questions Table
-- ========================================

-- Add subcategory_id column to questions
ALTER TABLE questions 
ADD COLUMN IF NOT EXISTS subcategory_id UUID REFERENCES subcategories(id) ON DELETE SET NULL;

-- Create index for subcategory lookups
CREATE INDEX IF NOT EXISTS idx_questions_subcategory 
ON questions(subcategory_id);

-- ========================================
-- 3. Clean up existing duplicates
-- ========================================

DO $$
DECLARE
  deleted_count INTEGER;
BEGIN
  -- Delete duplicate subcategories, keeping only the oldest one
  -- Using CTE with ROW_NUMBER() because MIN() doesn't work with UUID
  WITH duplicates_cte AS (
    SELECT 
      id,
      ROW_NUMBER() OVER (
        PARTITION BY category_id, name 
        ORDER BY created_at ASC, id
      ) as row_num
    FROM subcategories
  )
  DELETE FROM subcategories
  WHERE id IN (
    SELECT id FROM duplicates_cte WHERE row_num > 1
  );
  
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RAISE NOTICE 'Deleted % duplicate subcategories', deleted_count;
  
  -- Now create unique constraint to prevent future duplicates
  -- Must be created BEFORE inserts for ON CONFLICT to work
  DROP INDEX IF EXISTS idx_subcategories_unique;
  CREATE UNIQUE INDEX idx_subcategories_unique 
  ON subcategories(category_id, name);
  
  RAISE NOTICE 'Unique index created - ready for inserts';
END $$;

-- ========================================
-- 4. Insert Subcategories Data
-- ========================================

DO $$
DECLARE
  food_cat_id UUID;
  entertainment_cat_id UUID;
  animals_cat_id UUID;
  relationships_cat_id UUID;
  leisure_cat_id UUID;
  perception_cat_id UUID;
  misc_cat_id UUID;
BEGIN
  -- Get existing category IDs by icon (more reliable than name)
  SELECT id INTO food_cat_id FROM categories WHERE icon = 'üçï' LIMIT 1;
  SELECT id INTO entertainment_cat_id FROM categories WHERE icon = 'üé¨' LIMIT 1;
  SELECT id INTO animals_cat_id FROM categories WHERE icon = 'üê∂' LIMIT 1;
  SELECT id INTO relationships_cat_id FROM categories WHERE icon = 'üíû' LIMIT 1;
  SELECT id INTO leisure_cat_id FROM categories WHERE icon = 'üèñÔ∏è' LIMIT 1;
  
  -- Try to find by name if icon search failed
  IF food_cat_id IS NULL THEN
    SELECT id INTO food_cat_id FROM categories WHERE name ILIKE '%–µ–¥–∞%' OR name ILIKE '%food%' LIMIT 1;
  END IF;
  
  IF entertainment_cat_id IS NULL THEN
    SELECT id INTO entertainment_cat_id FROM categories WHERE name ILIKE '%—Ä–∞–∑–≤–ª–µ—á–µ–Ω%' OR name ILIKE '%—Ñ–∏–ª—å–º%' LIMIT 1;
  END IF;
  
  IF animals_cat_id IS NULL THEN
    SELECT id INTO animals_cat_id FROM categories WHERE name ILIKE '%–∂–∏–≤–æ—Ç–Ω%' OR name ILIKE '%animal%' LIMIT 1;
  END IF;
  
  IF relationships_cat_id IS NULL THEN
    SELECT id INTO relationships_cat_id FROM categories WHERE name ILIKE '%–æ—Ç–Ω–æ—à–µ–Ω%' OR name ILIKE '%–ª–∏—á–Ω–æ—Å—Ç%' LIMIT 1;
  END IF;
  
  IF leisure_cat_id IS NULL THEN
    SELECT id INTO leisure_cat_id FROM categories WHERE name ILIKE '%–¥–æ—Å—É–≥%' OR name ILIKE '%–ø—É—Ç–µ—à–µ—Å—Ç–≤%' LIMIT 1;
  END IF;
  
  -- If still not found, raise notice
  IF food_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Food category not found! Please create it first.';
  END IF;
  
  IF entertainment_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Entertainment category not found! Please create it first.';
  END IF;
  
  IF animals_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Animals category not found! Please create it first.';
  END IF;
  
  IF relationships_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Relationships category not found! Please create it first.';
  END IF;
  
  IF leisure_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Leisure category not found! Please create it first.';
  END IF;

  -- Insert Subcategories (only if category exists)

  -- üçï –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏
  IF food_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (food_cat_id, '–õ—é–±–∏–º–∞—è –∫—É—Ö–Ω—è', 1),
      (food_cat_id, '–õ—é–±–∏–º–æ–µ –±–ª—é–¥–æ', 2),
      (food_cat_id, '–ö–æ—Ñ–µ / —á–∞–π', 3),
      (food_cat_id, '–î–µ—Å–µ—Ä—Ç—ã', 4),
      (food_cat_id, '–£–ª–∏—á–Ω–∞—è –µ–¥–∞', 5),
      (food_cat_id, '–ó–∞–≤—Ç—Ä–∞–∫ –º–µ—á—Ç—ã', 6),
      (food_cat_id, '–†–µ—Å—Ç–æ—Ä–∞–Ω –º–µ—á—Ç—ã', 7)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Food subcategories: 7 items';
  END IF;

  -- üé¨ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞
  IF entertainment_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π —Ñ–∏–ª—å–º', 1),
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä –∫–∏–Ω–æ', 2),
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', 3),
      (entertainment_cat_id, '–õ—é–±–∏–º–∞—è –ø–µ—Å–Ω—è', 4),
      (entertainment_cat_id, '–°–µ—Ä–∏–∞–ª, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å', 5),
      (entertainment_cat_id, '–õ—é–±–∏–º–∞—è –∏–≥—Ä–∞ (–Ω–∞—Å—Ç–æ–ª—å–Ω–∞—è / –≤–∏–¥–µ–æ–∏–≥—Ä–∞)', 6),
      (entertainment_cat_id, '–°–∞–º—ã–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π —Ñ–∏–ª—å–º', 7)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Entertainment subcategories: 7 items';
  END IF;

  -- üê∂ –ñ–∏–≤–æ—Ç–Ω—ã–µ
  IF animals_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (animals_cat_id, '–õ—é–±–∏–º–∞—è –ø–æ—Ä–æ–¥–∞ —Å–æ–±–∞–∫', 1),
      (animals_cat_id, '–ö–æ—à–∫–∏ vs —Å–æ–±–∞–∫–∏', 2),
      (animals_cat_id, '–ò–¥–µ–∞–ª—å–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü', 3),
      (animals_cat_id, '–î–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞ –∏–ª–∏ –¥–æ–º–∞—à–Ω–∏–µ –ª—é–±–∏–º—Ü—ã', 4)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Animals subcategories: 4 items';
  END IF;

  -- üíû –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª–∏—á–Ω–æ—Å—Ç—å
  IF relationships_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (relationships_cat_id, '–ì–ª–∞–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ —á–µ–ª–æ–≤–µ–∫–µ', 1),
      (relationships_cat_id, '–ì–ª–∞–≤–Ω—ã–π —Å—Ç—Ä–∞—Ö', 2),
      (relationships_cat_id, '–ó–∞–≤–µ—Ç–Ω–∞—è –º–µ—á—Ç–∞', 3),
      (relationships_cat_id, '–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –¥—Ä—É–∂–±–µ', 4),
      (relationships_cat_id, '–ö–∞–∫ —Ç—ã –ø—Ä–æ—è–≤–ª—è–µ—à—å –∑–∞–±–æ—Ç—É', 5),
      (relationships_cat_id, '–õ—é–±–∏–º—ã–π —Ç–∏–ø –æ—Ç–¥—ã—Ö–∞ –≤–¥–≤–æ–µ–º', 6)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Relationships subcategories: 6 items';
  END IF;

  -- üèñÔ∏è –î–æ—Å—É–≥ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
  IF leisure_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (leisure_cat_id, '–õ—é–±–∏–º–æ–µ –º–µ—Å—Ç–æ –æ—Ç–¥—ã—Ö–∞', 1),
      (leisure_cat_id, '–ò–¥–µ–∞–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', 2),
      (leisure_cat_id, '–ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö –∏–ª–∏ —Ä–µ–ª–∞–∫—Å', 3),
      (leisure_cat_id, '–ì–æ—Ä–æ–¥ –º–µ—á—Ç—ã', 4),
      (leisure_cat_id, '–ò–¥–µ–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π', 5)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Leisure subcategories: 5 items';
  END IF;

  RAISE NOTICE '‚úÖ Subcategories created successfully!';
END $$;

-- ========================================
-- 5. Verification
-- ========================================

-- Check subcategories count
DO $$
DECLARE
  subcat_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO subcat_count FROM subcategories;
  RAISE NOTICE 'Total subcategories: %', subcat_count;
END $$;

-- Show subcategories grouped by category
SELECT 
  c.name as category_name,
  c.icon as category_icon,
  COUNT(sc.id) as subcategory_count
FROM categories c
LEFT JOIN subcategories sc ON sc.category_id = c.id
GROUP BY c.id, c.name, c.icon, c.order_index
ORDER BY c.order_index;

-- ============================================================
-- Subcategories Migration for MatchVibe
-- ============================================================
-- Adds subcategory structure to existing categories
-- Version: 2.0.0 (FIXED)
-- Date: 2025-01-09
-- Fix: Corrected UUID duplicate deletion method
-- ============================================================

-- ========================================
-- 1. Create Subcategories Table
-- ========================================

CREATE TABLE IF NOT EXISTS subcategories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  category_id UUID NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  icon TEXT,
  order_index INTEGER NOT NULL DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Add index for faster lookups
CREATE INDEX IF NOT EXISTS idx_subcategories_category 
ON subcategories(category_id, is_active, order_index);

-- Enable RLS
ALTER TABLE subcategories ENABLE ROW LEVEL SECURITY;

-- RLS Policy: Anyone can view active subcategories
DROP POLICY IF EXISTS "Subcategories are viewable by everyone" ON subcategories;
CREATE POLICY "Subcategories are viewable by everyone"
  ON subcategories FOR SELECT
  USING (is_active = TRUE);

-- ========================================
-- 2. Update Questions Table
-- ========================================

-- Add subcategory_id column to questions
ALTER TABLE questions 
ADD COLUMN IF NOT EXISTS subcategory_id UUID REFERENCES subcategories(id) ON DELETE SET NULL;

-- Create index for subcategory lookups
CREATE INDEX IF NOT EXISTS idx_questions_subcategory 
ON questions(subcategory_id);

-- ========================================
-- 3. Clean up existing duplicates
-- ========================================

DO $$
DECLARE
  deleted_count INTEGER;
BEGIN
  -- Delete duplicate subcategories, keeping only the oldest one
  -- Using CTE with ROW_NUMBER() because MIN() doesn't work with UUID
  WITH duplicates_cte AS (
    SELECT 
      id,
      ROW_NUMBER() OVER (
        PARTITION BY category_id, name 
        ORDER BY created_at ASC, id
      ) as row_num
    FROM subcategories
  )
  DELETE FROM subcategories
  WHERE id IN (
    SELECT id FROM duplicates_cte WHERE row_num > 1
  );
  
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RAISE NOTICE 'Deleted % duplicate subcategories', deleted_count;
  
  -- Now create unique constraint to prevent future duplicates
  -- Must be created BEFORE inserts for ON CONFLICT to work
  DROP INDEX IF EXISTS idx_subcategories_unique;
  CREATE UNIQUE INDEX idx_subcategories_unique 
  ON subcategories(category_id, name);
  
  RAISE NOTICE 'Unique index created - ready for inserts';
END $$;

-- ========================================
-- 4. Insert Subcategories Data
-- ========================================

DO $$
DECLARE
  food_cat_id UUID;
  entertainment_cat_id UUID;
  animals_cat_id UUID;
  relationships_cat_id UUID;
  leisure_cat_id UUID;
  perception_cat_id UUID;
  misc_cat_id UUID;
BEGIN
  -- Get existing category IDs by icon (more reliable than name)
  SELECT id INTO food_cat_id FROM categories WHERE icon = 'üçï' LIMIT 1;
  SELECT id INTO entertainment_cat_id FROM categories WHERE icon = 'üé¨' LIMIT 1;
  SELECT id INTO animals_cat_id FROM categories WHERE icon = 'üê∂' LIMIT 1;
  SELECT id INTO relationships_cat_id FROM categories WHERE icon = 'üíû' LIMIT 1;
  SELECT id INTO leisure_cat_id FROM categories WHERE icon = 'üèñÔ∏è' LIMIT 1;
  
  -- Try to find by name if icon search failed
  IF food_cat_id IS NULL THEN
    SELECT id INTO food_cat_id FROM categories WHERE name ILIKE '%–µ–¥–∞%' OR name ILIKE '%food%' LIMIT 1;
  END IF;
  
  IF entertainment_cat_id IS NULL THEN
    SELECT id INTO entertainment_cat_id FROM categories WHERE name ILIKE '%—Ä–∞–∑–≤–ª–µ—á–µ–Ω%' OR name ILIKE '%—Ñ–∏–ª—å–º%' LIMIT 1;
  END IF;
  
  IF animals_cat_id IS NULL THEN
    SELECT id INTO animals_cat_id FROM categories WHERE name ILIKE '%–∂–∏–≤–æ—Ç–Ω%' OR name ILIKE '%animal%' LIMIT 1;
  END IF;
  
  IF relationships_cat_id IS NULL THEN
    SELECT id INTO relationships_cat_id FROM categories WHERE name ILIKE '%–æ—Ç–Ω–æ—à–µ–Ω%' OR name ILIKE '%–ª–∏—á–Ω–æ—Å—Ç%' LIMIT 1;
  END IF;
  
  IF leisure_cat_id IS NULL THEN
    SELECT id INTO leisure_cat_id FROM categories WHERE name ILIKE '%–¥–æ—Å—É–≥%' OR name ILIKE '%–ø—É—Ç–µ—à–µ—Å—Ç–≤%' LIMIT 1;
  END IF;
  
  -- If still not found, raise notice
  IF food_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Food category not found! Please create it first.';
  END IF;
  
  IF entertainment_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Entertainment category not found! Please create it first.';
  END IF;
  
  IF animals_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Animals category not found! Please create it first.';
  END IF;
  
  IF relationships_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Relationships category not found! Please create it first.';
  END IF;
  
  IF leisure_cat_id IS NULL THEN
    RAISE NOTICE 'WARNING: Leisure category not found! Please create it first.';
  END IF;

  -- Insert Subcategories (only if category exists)

  -- üçï –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏
  IF food_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (food_cat_id, '–õ—é–±–∏–º–∞—è –∫—É—Ö–Ω—è', 1),
      (food_cat_id, '–õ—é–±–∏–º–æ–µ –±–ª—é–¥–æ', 2),
      (food_cat_id, '–ö–æ—Ñ–µ / —á–∞–π', 3),
      (food_cat_id, '–î–µ—Å–µ—Ä—Ç—ã', 4),
      (food_cat_id, '–£–ª–∏—á–Ω–∞—è –µ–¥–∞', 5),
      (food_cat_id, '–ó–∞–≤—Ç—Ä–∞–∫ –º–µ—á—Ç—ã', 6),
      (food_cat_id, '–†–µ—Å—Ç–æ—Ä–∞–Ω –º–µ—á—Ç—ã', 7)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Food subcategories: 7 items';
  END IF;

  -- üé¨ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞
  IF entertainment_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π —Ñ–∏–ª—å–º', 1),
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä –∫–∏–Ω–æ', 2),
      (entertainment_cat_id, '–õ—é–±–∏–º—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', 3),
      (entertainment_cat_id, '–õ—é–±–∏–º–∞—è –ø–µ—Å–Ω—è', 4),
      (entertainment_cat_id, '–°–µ—Ä–∏–∞–ª, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å', 5),
      (entertainment_cat_id, '–õ—é–±–∏–º–∞—è –∏–≥—Ä–∞ (–Ω–∞—Å—Ç–æ–ª—å–Ω–∞—è / –≤–∏–¥–µ–æ–∏–≥—Ä–∞)', 6),
      (entertainment_cat_id, '–°–∞–º—ã–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π —Ñ–∏–ª—å–º', 7)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Entertainment subcategories: 7 items';
  END IF;

  -- üê∂ –ñ–∏–≤–æ—Ç–Ω—ã–µ
  IF animals_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (animals_cat_id, '–õ—é–±–∏–º–∞—è –ø–æ—Ä–æ–¥–∞ —Å–æ–±–∞–∫', 1),
      (animals_cat_id, '–ö–æ—à–∫–∏ vs —Å–æ–±–∞–∫–∏', 2),
      (animals_cat_id, '–ò–¥–µ–∞–ª—å–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü', 3),
      (animals_cat_id, '–î–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞ –∏–ª–∏ –¥–æ–º–∞—à–Ω–∏–µ –ª—é–±–∏–º—Ü—ã', 4)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Animals subcategories: 4 items';
  END IF;

  -- üíû –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª–∏—á–Ω–æ—Å—Ç—å
  IF relationships_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (relationships_cat_id, '–ì–ª–∞–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ —á–µ–ª–æ–≤–µ–∫–µ', 1),
      (relationships_cat_id, '–ì–ª–∞–≤–Ω—ã–π —Å—Ç—Ä–∞—Ö', 2),
      (relationships_cat_id, '–ó–∞–≤–µ—Ç–Ω–∞—è –º–µ—á—Ç–∞', 3),
      (relationships_cat_id, '–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –¥—Ä—É–∂–±–µ', 4),
      (relationships_cat_id, '–ö–∞–∫ —Ç—ã –ø—Ä–æ—è–≤–ª—è–µ—à—å –∑–∞–±–æ—Ç—É', 5),
      (relationships_cat_id, '–õ—é–±–∏–º—ã–π —Ç–∏–ø –æ—Ç–¥—ã—Ö–∞ –≤–¥–≤–æ–µ–º', 6)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Relationships subcategories: 6 items';
  END IF;

  -- üèñÔ∏è –î–æ—Å—É–≥ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
  IF leisure_cat_id IS NOT NULL THEN
    INSERT INTO subcategories (category_id, name, order_index) 
    VALUES
      (leisure_cat_id, '–õ—é–±–∏–º–æ–µ –º–µ—Å—Ç–æ –æ—Ç–¥—ã—Ö–∞', 1),
      (leisure_cat_id, '–ò–¥–µ–∞–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', 2),
      (leisure_cat_id, '–ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö –∏–ª–∏ —Ä–µ–ª–∞–∫—Å', 3),
      (leisure_cat_id, '–ì–æ—Ä–æ–¥ –º–µ—á—Ç—ã', 4),
      (leisure_cat_id, '–ò–¥–µ–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π', 5)
    ON CONFLICT (category_id, name) DO NOTHING;
    RAISE NOTICE 'Leisure subcategories: 5 items';
  END IF;

  RAISE NOTICE '‚úÖ Subcategories created successfully!';
END $$;

-- ========================================
-- 5. Verification
-- ========================================

-- Check subcategories count
DO $$
DECLARE
  subcat_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO subcat_count FROM subcategories;
  RAISE NOTICE 'Total subcategories: %', subcat_count;
END $$;

-- Show subcategories grouped by category
SELECT 
  c.name as category_name,
  c.icon as category_icon,
  COUNT(sc.id) as subcategory_count
FROM categories c
LEFT JOIN subcategories sc ON sc.category_id = c.id
GROUP BY c.id, c.name, c.icon, c.order_index
ORDER BY c.order_index;

WITH duplicates_cte AS (
  SELECT 
    id,
    ROW_NUMBER() OVER (
      PARTITION BY text, category_id 
      ORDER BY created_at ASC, id
    ) as row_num
  FROM questions
  WHERE is_active = true
)
DELETE FROM questions
WHERE id IN (
  SELECT id FROM duplicates_cte WHERE row_num > 1
);

-- Part 1: –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ (105 –≤–æ–ø—Ä–æ—Å–æ–≤)
DO $$ 
DECLARE v_id UUID;
BEGIN
  -- 1.1 –õ—é–±–∏–º–∞—è –∫—É—Ö–Ω—è
  SELECT id INTO v_id FROM subcategories WHERE name='–õ—é–±–∏–º–∞—è –∫—É—Ö–Ω—è' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-1.jpg',1),
    (v_id,'–Ø–ø–æ–Ω—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-2.jpg',2),
    (v_id,'–ú–µ–∫—Å–∏–∫–∞–Ω—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-3.jpg',3),
    (v_id,'–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-4.jpg',4),
    (v_id,'–ö–∏—Ç–∞–π—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-5.jpg',5),
    (v_id,'–ò–Ω–¥–∏–π—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-6.jpg',6),
    (v_id,'–¢–∞–π—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-7.jpg',7),
    (v_id,'–ì—Ä—É–∑–∏–Ω—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-8.jpg',8),
    (v_id,'–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-9.jpg',9),
    (v_id,'–ö–æ—Ä–µ–π—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-10.jpg',10),
    (v_id,'–í—å–µ—Ç–Ω–∞–º—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-11.jpg',11),
    (v_id,'–¢—É—Ä–µ—Ü–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-12.jpg',12),
    (v_id,'–ò—Å–ø–∞–Ω—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-13.jpg',13),
    (v_id,'–†—É—Å—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-14.jpg',14),
    (v_id,'–ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∞—è','/images/subcategories/food-favorite-cuisine/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –õ—é–±–∏–º–∞—è –∫—É—Ö–Ω—è: 15';
  END IF;

  -- 1.2 –õ—é–±–∏–º–æ–µ –±–ª—é–¥–æ
  SELECT id INTO v_id FROM subcategories WHERE name='–õ—é–±–∏–º–æ–µ –±–ª—é–¥–æ' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞','/images/subcategories/food-favorite-dish/card-1.jpg',1),
    (v_id,'–ë–æ—Ä—â','/images/subcategories/food-favorite-dish/card-2.jpg',2),
    (v_id,'–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞','/images/subcategories/food-favorite-dish/card-3.jpg',3),
    (v_id,'–°—É—à–∏ –°–µ—Ç','/images/subcategories/food-favorite-dish/card-4.jpg',4),
    (v_id,'–°—Ç–µ–π–∫ –†–∏–±–∞–π','/images/subcategories/food-favorite-dish/card-5.jpg',5),
    (v_id,'–†–∞–º–µ–Ω','/images/subcategories/food-favorite-dish/card-6.jpg',6),
    (v_id,'–õ–∞–∑–∞–Ω—å—è','/images/subcategories/food-favorite-dish/card-7.jpg',7),
    (v_id,'–•–∞—á–∞–ø—É—Ä–∏','/images/subcategories/food-favorite-dish/card-8.jpg',8),
    (v_id,'–ü–µ–ª—å–º–µ–Ω–∏','/images/subcategories/food-favorite-dish/card-9.jpg',9),
    (v_id,'–ë—É—Ä–≥–µ—Ä','/images/subcategories/food-favorite-dish/card-10.jpg',10),
    (v_id,'–†–∏–∑–æ—Ç—Ç–æ','/images/subcategories/food-favorite-dish/card-11.jpg',11),
    (v_id,'–®–∞—à–ª—ã–∫','/images/subcategories/food-favorite-dish/card-12.jpg',12),
    (v_id,'–ü–ª–æ–≤','/images/subcategories/food-favorite-dish/card-13.jpg',13),
    (v_id,'–¢–æ–º –Ø–º','/images/subcategories/food-favorite-dish/card-14.jpg',14),
    (v_id,'–£—Ç–∫–∞ –ø–æ-–ø–µ–∫–∏–Ω—Å–∫–∏','/images/subcategories/food-favorite-dish/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –õ—é–±–∏–º–æ–µ –±–ª—é–¥–æ: 15';
  END IF;

  -- 1.3 –ö–æ—Ñ–µ / —á–∞–π
  SELECT id INTO v_id FROM subcategories WHERE name='–ö–æ—Ñ–µ / —á–∞–π' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–≠—Å–ø—Ä–µ—Å—Å–æ','/images/subcategories/food-coffee-tea/card-1.jpg',1),
    (v_id,'–ö–∞–ø—É—á–∏–Ω–æ','/images/subcategories/food-coffee-tea/card-2.jpg',2),
    (v_id,'–õ–∞—Ç—Ç–µ','/images/subcategories/food-coffee-tea/card-3.jpg',3),
    (v_id,'–ß–µ—Ä–Ω—ã–π —á–∞–π','/images/subcategories/food-coffee-tea/card-4.jpg',4),
    (v_id,'–ó–µ–ª–µ–Ω—ã–π —á–∞–π','/images/subcategories/food-coffee-tea/card-5.jpg',5),
    (v_id,'–ú–∞—Ç—á–∞','/images/subcategories/food-coffee-tea/card-6.jpg',6),
    (v_id,'–ê–º–µ—Ä–∏–∫–∞–Ω–æ','/images/subcategories/food-coffee-tea/card-7.jpg',7),
    (v_id,'–§–ª—ç—Ç –£–∞–π—Ç','/images/subcategories/food-coffee-tea/card-8.jpg',8),
    (v_id,'–†–∞—Ñ','/images/subcategories/food-coffee-tea/card-9.jpg',9),
    (v_id,'–¢—Ä–∞–≤—è–Ω–æ–π —á–∞–π','/images/subcategories/food-coffee-tea/card-10.jpg',10),
    (v_id,'–§—Ä–∞–ø–ø—É—á–∏–Ω–æ','/images/subcategories/food-coffee-tea/card-11.jpg',11),
    (v_id,'–ú–∞—Å–∞–ª–∞ —á–∞–π','/images/subcategories/food-coffee-tea/card-12.jpg',12),
    (v_id,'–¢—É—Ä–µ—Ü–∫–∏–π –∫–æ—Ñ–µ','/images/subcategories/food-coffee-tea/card-13.jpg',13),
    (v_id,'–ü—É—ç—Ä','/images/subcategories/food-coffee-tea/card-14.jpg',14),
    (v_id,'–ö–æ–ª–¥ –±—Ä—é','/images/subcategories/food-coffee-tea/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –ö–æ—Ñ–µ / —á–∞–π: 15';
  END IF;

  -- 1.4 –î–µ—Å–µ—Ä—Ç—ã
  SELECT id INTO v_id FROM subcategories WHERE name='–î–µ—Å–µ—Ä—Ç—ã' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–¢–∏—Ä–∞–º–∏—Å—É','/images/subcategories/food-desserts/card-1.jpg',1),
    (v_id,'–ß–∏–∑–∫–µ–π–∫','/images/subcategories/food-desserts/card-2.jpg',2),
    (v_id,'–ë—Ä–∞—É–Ω–∏','/images/subcategories/food-desserts/card-3.jpg',3),
    (v_id,'–ú–∞–∫–∞—Ä—É–Ω—ã','/images/subcategories/food-desserts/card-4.jpg',4),
    (v_id,'–≠–∫–ª–µ—Ä—ã','/images/subcategories/food-desserts/card-5.jpg',5),
    (v_id,'–ü–∞–Ω–Ω–∞-–∫–æ—Ç—Ç–∞','/images/subcategories/food-desserts/card-6.jpg',6),
    (v_id,'–ú–µ–¥–æ–≤–∏–∫','/images/subcategories/food-desserts/card-7.jpg',7),
    (v_id,'–ü—Ä–æ—Ñ–∏—Ç—Ä–æ–ª–∏','/images/subcategories/food-desserts/card-8.jpg',8),
    (v_id,'–ü–∞–≤–ª–æ–≤–∞','/images/subcategories/food-desserts/card-9.jpg',9),
    (v_id,'–®—Ç—Ä—É–¥–µ–ª—å','/images/subcategories/food-desserts/card-10.jpg',10),
    (v_id,'–ö—Ä–µ–º-–±—Ä—é–ª–µ','/images/subcategories/food-desserts/card-11.jpg',11),
    (v_id,'–ù–∞–ø–æ–ª–µ–æ–Ω','/images/subcategories/food-desserts/card-12.jpg',12),
    (v_id,'–ü–∞—Ö–ª–∞–≤–∞','/images/subcategories/food-desserts/card-13.jpg',13),
    (v_id,'–ú–∞—Ñ—Ñ–∏–Ω—ã','/images/subcategories/food-desserts/card-14.jpg',14),
    (v_id,'–ú–æ—Ä–æ–∂–µ–Ω–æ–µ','/images/subcategories/food-desserts/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –î–µ—Å–µ—Ä—Ç—ã: 15';
  END IF;

  -- 1.5 –£–ª–∏—á–Ω–∞—è –µ–¥–∞
  SELECT id INTO v_id FROM subcategories WHERE name='–£–ª–∏—á–Ω–∞—è –µ–¥–∞' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–•–æ—Ç-–¥–æ–≥','/images/subcategories/food-street-food/card-1.jpg',1),
    (v_id,'–®–∞—É—Ä–º–∞','/images/subcategories/food-street-food/card-2.jpg',2),
    (v_id,'–¢–∞–∫–æ','/images/subcategories/food-street-food/card-3.jpg',3),
    (v_id,'–ë—É—Ä–≥–µ—Ä','/images/subcategories/food-street-food/card-4.jpg',4),
    (v_id,'–ö–æ—Ä–Ω-–¥–æ–≥','/images/subcategories/food-street-food/card-5.jpg',5),
    (v_id,'–§–∞–ª–∞—Ñ–µ–ª—å','/images/subcategories/food-street-food/card-6.jpg',6),
    (v_id,'–ü–∏—Ä–æ–∂–æ–∫','/images/subcategories/food-street-food/card-7.jpg',7),
    (v_id,'–ß–µ–±—É—Ä–µ–∫','/images/subcategories/food-street-food/card-8.jpg',8),
    (v_id,'–ë–∞–Ω—å-–º–∏','/images/subcategories/food-street-food/card-9.jpg',9),
    (v_id,'–°—ç–Ω–¥–≤–∏—á','/images/subcategories/food-street-food/card-10.jpg',10),
    (v_id,'–°–∞–º—Å–∞','/images/subcategories/food-street-food/card-11.jpg',11),
    (v_id,'–í–∞—Ñ–ª–∏','/images/subcategories/food-street-food/card-12.jpg',12),
    (v_id,'–ë–ª–∏–Ω—ã','/images/subcategories/food-street-food/card-13.jpg',13),
    (v_id,'–ü–∏—Ü—Ü–∞ –∫—É—Å–æ—á–µ–∫','/images/subcategories/food-street-food/card-14.jpg',14),
    (v_id,'–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏','/images/subcategories/food-street-food/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –£–ª–∏—á–Ω–∞—è –µ–¥–∞: 15';
  END IF;

  -- 1.6 –ó–∞–≤—Ç—Ä–∞–∫ –º–µ—á—Ç—ã
  SELECT id INTO v_id FROM subcategories WHERE name='–ó–∞–≤—Ç—Ä–∞–∫ –º–µ—á—Ç—ã' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ü–∞–Ω–∫–µ–π–∫–∏ —Å —è–≥–æ–¥–∞–º–∏','/images/subcategories/food-dream-breakfast/card-1.jpg',1),
    (v_id,'–ö—Ä—É–∞—Å—Å–∞–Ω—ã','/images/subcategories/food-dream-breakfast/card-2.jpg',2),
    (v_id,'–Ø–∏—á–Ω–∏—Ü–∞ —Å –±–µ–∫–æ–Ω–æ–º','/images/subcategories/food-dream-breakfast/card-3.jpg',3),
    (v_id,'–ê–≤–æ–∫–∞–¥–æ —Ç–æ—Å—Ç','/images/subcategories/food-dream-breakfast/card-4.jpg',4),
    (v_id,'–û–≤—Å—è–Ω–∫–∞ —Å —Ñ—Ä—É–∫—Ç–∞–º–∏','/images/subcategories/food-dream-breakfast/card-5.jpg',5),
    (v_id,'–ë–µ–ª—å–≥–∏–π—Å–∫–∏–µ –≤–∞—Ñ–ª–∏','/images/subcategories/food-dream-breakfast/card-6.jpg',6),
    (v_id,'–û–º–ª–µ—Ç','/images/subcategories/food-dream-breakfast/card-7.jpg',7),
    (v_id,'–ì—Ä–∞–Ω–æ–ª–∞ —Å –π–æ–≥—É—Ä—Ç–æ–º','/images/subcategories/food-dream-breakfast/card-8.jpg',8),
    (v_id,'–ë–µ–π–≥–ª—ã —Å –ª–æ—Å–æ—Å–µ–º','/images/subcategories/food-dream-breakfast/card-9.jpg',9),
    (v_id,'–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–µ —Ç–æ—Å—Ç—ã','/images/subcategories/food-dream-breakfast/card-10.jpg',10),
    (v_id,'–°—ã—Ä–Ω–∏–∫–∏','/images/subcategories/food-dream-breakfast/card-11.jpg',11),
    (v_id,'–°–º—É–∑–∏ –±–æ—É–ª','/images/subcategories/food-dream-breakfast/card-12.jpg',12),
    (v_id,'–ê–Ω–≥–ª–∏–π—Å–∫–∏–π –∑–∞–≤—Ç—Ä–∞–∫','/images/subcategories/food-dream-breakfast/card-13.jpg',13),
    (v_id,'–®–∞–∫—à—É–∫–∞','/images/subcategories/food-dream-breakfast/card-14.jpg',14),
    (v_id,'–ë–ª–∏–Ω—á–∏–∫–∏','/images/subcategories/food-dream-breakfast/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –ó–∞–≤—Ç—Ä–∞–∫ –º–µ—á—Ç—ã: 15';
  END IF;

  -- 1.7 –†–µ—Å—Ç–æ—Ä–∞–Ω –º–µ—á—Ç—ã
  SELECT id INTO v_id FROM subcategories WHERE name='–†–µ—Å—Ç–æ—Ä–∞–Ω –º–µ—á—Ç—ã' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ú–∏—à–ª–µ–Ω–æ–≤—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω','/images/subcategories/food-dream-restaurant/card-1.jpg',1),
    (v_id,'–ü–∞–Ω–æ—Ä–∞–º–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω','/images/subcategories/food-dream-restaurant/card-2.jpg',2),
    (v_id,'–†–µ—Å—Ç–æ—Ä–∞–Ω —É –º–æ—Ä—è','/images/subcategories/food-dream-restaurant/card-3.jpg',3),
    (v_id,'–Ø–ø–æ–Ω—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω','/images/subcategories/food-dream-restaurant/card-4.jpg',4),
    (v_id,'–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è —Ç—Ä–∞—Ç—Ç–æ—Ä–∏—è','/images/subcategories/food-dream-restaurant/card-5.jpg',5),
    (v_id,'–°—Ç–µ–π–∫-—Ö–∞—É—Å','/images/subcategories/food-dream-restaurant/card-6.jpg',6),
    (v_id,'–í–µ–≥–∞–Ω—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω','/images/subcategories/food-dream-restaurant/card-7.jpg',7),
    (v_id,'–ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–∞—è –∫—É—Ö–Ω—è','/images/subcategories/food-dream-restaurant/card-8.jpg',8),
    (v_id,'–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞ –≤–æ–¥–µ','/images/subcategories/food-dream-restaurant/card-9.jpg',9),
    (v_id,'–†–µ—Å—Ç–æ—Ä–∞–Ω –≤ –∑–∞–º–∫–µ','/images/subcategories/food-dream-restaurant/card-10.jpg',10),
    (v_id,'–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω','/images/subcategories/food-dream-restaurant/card-11.jpg',11),
    (v_id,'–ì–∞—Å—Ç—Ä–æ–ø–∞–±','/images/subcategories/food-dream-restaurant/card-12.jpg',12),
    (v_id,'–†–µ—Å—Ç–æ—Ä–∞–Ω –≤ —Å–∞–¥—É','/images/subcategories/food-dream-restaurant/card-13.jpg',13),
    (v_id,'–°–µ–º–µ–π–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω','/images/subcategories/food-dream-restaurant/card-14.jpg',14),
    (v_id,'–§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π','/images/subcategories/food-dream-restaurant/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –†–µ—Å—Ç–æ—Ä–∞–Ω –º–µ—á—Ç—ã: 15';
  END IF;

  RAISE NOTICE 'üçï –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏: 105 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ';
END $$;

-- Part 2: –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞ (105 –≤–æ–ø—Ä–æ—Å–æ–≤)
DO $$ 
DECLARE v_id UUID;
BEGIN
  -- 2.1 –õ—é–±–∏–º—ã–π —Ñ–∏–ª—å–º
  SELECT id INTO v_id FROM subcategories WHERE name='–õ—é–±–∏–º—ã–π —Ñ–∏–ª—å–º' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ö—Ä–∏–º–∏–Ω–∞–ª—å–Ω–æ–µ —á—Ç–∏–≤–æ','/images/subcategories/entertainment-favorite-movie/card-1.jpg',1),
    (v_id,'–ù–∞—á–∞–ª–æ','/images/subcategories/entertainment-favorite-movie/card-2.jpg',2),
    (v_id,'–ë–æ–π—Ü–æ–≤—Å–∫–∏–π –∫–ª—É–±','/images/subcategories/entertainment-favorite-movie/card-3.jpg',3),
    (v_id,'–§–æ—Ä—Ä–µ—Å—Ç –ì–∞–º–ø','/images/subcategories/entertainment-favorite-movie/card-4.jpg',4),
    (v_id,'–ú–∞—Ç—Ä–∏—Ü–∞','/images/subcategories/entertainment-favorite-movie/card-5.jpg',5),
    (v_id,'–¢–∏—Ç–∞–Ω–∏–∫','/images/subcategories/entertainment-favorite-movie/card-6.jpg',6),
    (v_id,'–ó–µ–ª–µ–Ω–∞—è –º–∏–ª—è','/images/subcategories/entertainment-favorite-movie/card-7.jpg',7),
    (v_id,'–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä','/images/subcategories/entertainment-favorite-movie/card-8.jpg',8),
    (v_id,'–ö—Ä–µ—Å—Ç–Ω—ã–π –æ—Ç–µ—Ü','/images/subcategories/entertainment-favorite-movie/card-9.jpg',9),
    (v_id,'–¢–µ–º–Ω—ã–π —Ä—ã—Ü–∞—Ä—å','/images/subcategories/entertainment-favorite-movie/card-10.jpg',10),
    (v_id,'1+1','/images/subcategories/entertainment-favorite-movie/card-11.jpg',11),
    (v_id,'–ü–æ–±–µ–≥ –∏–∑ –®–æ—É—à–µ–Ω–∫–∞','/images/subcategories/entertainment-favorite-movie/card-12.jpg',12),
    (v_id,'–õ–µ–æ–Ω','/images/subcategories/entertainment-favorite-movie/card-13.jpg',13),
    (v_id,'–í–ª–∞—Å—Ç–µ–ª–∏–Ω –∫–æ–ª–µ—Ü','/images/subcategories/entertainment-favorite-movie/card-14.jpg',14),
    (v_id,'–î–∂–æ–∫–µ—Ä','/images/subcategories/entertainment-favorite-movie/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –õ—é–±–∏–º—ã–π —Ñ–∏–ª—å–º: 15';
  END IF;

  -- 2.2 –õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä –∫–∏–Ω–æ
  SELECT id INTO v_id FROM subcategories WHERE name='–õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä –∫–∏–Ω–æ' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ö–æ–º–µ–¥–∏–∏','/images/subcategories/entertainment-movie-genre/card-1.jpg',1),
    (v_id,'–ë–æ–µ–≤–∏–∫–∏','/images/subcategories/entertainment-movie-genre/card-2.jpg',2),
    (v_id,'–†–æ–º–∞–Ω—Ç–∏–∫–∞','/images/subcategories/entertainment-movie-genre/card-3.jpg',3),
    (v_id,'–£–∂–∞—Å—ã','/images/subcategories/entertainment-movie-genre/card-4.jpg',4),
    (v_id,'–ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞','/images/subcategories/entertainment-movie-genre/card-5.jpg',5),
    (v_id,'–§—ç–Ω—Ç–µ–∑–∏','/images/subcategories/entertainment-movie-genre/card-6.jpg',6),
    (v_id,'–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ','/images/subcategories/entertainment-movie-genre/card-7.jpg',7),
    (v_id,'–î—Ä–∞–º–∞','/images/subcategories/entertainment-movie-genre/card-8.jpg',8),
    (v_id,'–¢—Ä–∏–ª–ª–µ—Ä—ã','/images/subcategories/entertainment-movie-genre/card-9.jpg',9),
    (v_id,'–ê–Ω–∏–º–∞—Ü–∏—è','/images/subcategories/entertainment-movie-genre/card-10.jpg',10),
    (v_id,'–î–µ—Ç–µ–∫—Ç–∏–≤—ã','/images/subcategories/entertainment-movie-genre/card-11.jpg',11),
    (v_id,'–ú—é–∑–∏–∫–ª—ã','/images/subcategories/entertainment-movie-genre/card-12.jpg',12),
    (v_id,'–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è','/images/subcategories/entertainment-movie-genre/card-13.jpg',13),
    (v_id,'–ë–∏–æ–≥—Ä–∞—Ñ–∏–∏','/images/subcategories/entertainment-movie-genre/card-14.jpg',14),
    (v_id,'–ê—Ä—Ç—Ö–∞—É—Å','/images/subcategories/entertainment-movie-genre/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä –∫–∏–Ω–æ: 15';
  END IF;

  -- 2.3 –õ—é–±–∏–º—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
  SELECT id INTO v_id FROM subcategories WHERE name='–õ—é–±–∏–º—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–†–æ–∫-–≥—Ä—É–ø–ø–∞','/images/subcategories/entertainment-favorite-artist/card-1.jpg',1),
    (v_id,'–ü–æ–ø-–∑–≤–µ–∑–¥–∞','/images/subcategories/entertainment-favorite-artist/card-2.jpg',2),
    (v_id,'–†—ç–ø-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å','/images/subcategories/entertainment-favorite-artist/card-3.jpg',3),
    (v_id,'–î–∂–∞–∑–æ–≤—ã–π –º—É–∑—ã–∫–∞–Ω—Ç','/images/subcategories/entertainment-favorite-artist/card-4.jpg',4),
    (v_id,'–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π DJ','/images/subcategories/entertainment-favorite-artist/card-5.jpg',5),
    (v_id,'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä','/images/subcategories/entertainment-favorite-artist/card-6.jpg',6),
    (v_id,'–ò–Ω–¥–∏-–≥—Ä—É–ø–ø–∞','/images/subcategories/entertainment-favorite-artist/card-7.jpg',7),
    (v_id,'–ö–∞–Ω—Ç—Ä–∏-–ø–µ–≤–µ—Ü','/images/subcategories/entertainment-favorite-artist/card-8.jpg',8),
    (v_id,'–ú–µ—Ç–∞–ª-–≥—Ä—É–ø–ø–∞','/images/subcategories/entertainment-favorite-artist/card-9.jpg',9),
    (v_id,'R&B –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å','/images/subcategories/entertainment-favorite-artist/card-10.jpg',10),
    (v_id,'–§–æ–ª–∫-–º—É–∑—ã–∫–∞–Ω—Ç','/images/subcategories/entertainment-favorite-artist/card-11.jpg',11),
    (v_id,'–†–µ–≥–≥–∏-–∞—Ä—Ç–∏—Å—Ç','/images/subcategories/entertainment-favorite-artist/card-12.jpg',12),
    (v_id,'–ë–ª—é–∑-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å','/images/subcategories/entertainment-favorite-artist/card-13.jpg',13),
    (v_id,'K-Pop –≥—Ä—É–ø–ø–∞','/images/subcategories/entertainment-favorite-artist/card-14.jpg',14),
    (v_id,'–û–ø–µ—Ä–Ω—ã–π –ø–µ–≤–µ—Ü','/images/subcategories/entertainment-favorite-artist/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –õ—é–±–∏–º—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: 15';
  END IF;

  -- 2.4 –õ—é–±–∏–º–∞—è –ø–µ—Å–Ω—è
  SELECT id INTO v_id FROM subcategories WHERE name='–õ—é–±–∏–º–∞—è –ø–µ—Å–Ω—è' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–†–æ–∫-–±–∞–ª–ª–∞–¥–∞','/images/subcategories/entertainment-favorite-song/card-1.jpg',1),
    (v_id,'–¢–∞–Ω—Ü–µ–≤–∞–ª—å–Ω—ã–π —Ö–∏—Ç','/images/subcategories/entertainment-favorite-song/card-2.jpg',2),
    (v_id,'–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Å–Ω—è','/images/subcategories/entertainment-favorite-song/card-3.jpg',3),
    (v_id,'–ì–∏–º–Ω –ø–æ–∫–æ–ª–µ–Ω–∏—è','/images/subcategories/entertainment-favorite-song/card-4.jpg',4),
    (v_id,'–õ–µ—Ç–Ω–∏–π —Ö–∏—Ç','/images/subcategories/entertainment-favorite-song/card-5.jpg',5),
    (v_id,'–ì—Ä—É—Å—Ç–Ω–∞—è –ø–µ—Å–Ω—è','/images/subcategories/entertainment-favorite-song/card-6.jpg',6),
    (v_id,'–ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ç—Ä–µ–∫','/images/subcategories/entertainment-favorite-song/card-7.jpg',7),
    (v_id,'–†–µ—Ç—Ä–æ-—Ö–∏—Ç','/images/subcategories/entertainment-favorite-song/card-8.jpg',8),
    (v_id,'–†—ç–ø-—Ç—Ä–µ–∫','/images/subcategories/entertainment-favorite-song/card-9.jpg',9),
    (v_id,'–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π —Ç—Ä–µ–∫','/images/subcategories/entertainment-favorite-song/card-10.jpg',10),
    (v_id,'–î–∂–∞–∑–æ–≤–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è','/images/subcategories/entertainment-favorite-song/card-11.jpg',11),
    (v_id,'–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Å–Ω—è','/images/subcategories/entertainment-favorite-song/card-12.jpg',12),
    (v_id,'–ü–µ—Å–Ω—è –∏–∑ —Ñ–∏–ª—å–º–∞','/images/subcategories/entertainment-favorite-song/card-13.jpg',13),
    (v_id,'–ö–∞–≤–µ—Ä-–≤–µ—Ä—Å–∏—è','/images/subcategories/entertainment-favorite-song/card-14.jpg',14),
    (v_id,'–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è','/images/subcategories/entertainment-favorite-song/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –õ—é–±–∏–º–∞—è –ø–µ—Å–Ω—è: 15';
  END IF;

  -- 2.5 –°–µ—Ä–∏–∞–ª, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å
  SELECT id INTO v_id FROM subcategories WHERE name='–°–µ—Ä–∏–∞–ª, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ò–≥—Ä–∞ –ø—Ä–µ—Å—Ç–æ–ª–æ–≤','/images/subcategories/entertainment-series/card-1.jpg',1),
    (v_id,'–î—Ä—É–∑—å—è','/images/subcategories/entertainment-series/card-2.jpg',2),
    (v_id,'–í–æ –≤—Å–µ —Ç—è–∂–∫–∏–µ','/images/subcategories/entertainment-series/card-3.jpg',3),
    (v_id,'–®–µ—Ä–ª–æ–∫','/images/subcategories/entertainment-series/card-4.jpg',4),
    (v_id,'–û—Ñ–∏—Å','/images/subcategories/entertainment-series/card-5.jpg',5),
    (v_id,'–°—Ç—Ä–∞–Ω–Ω—ã–µ –¥–µ–ª–∞','/images/subcategories/entertainment-series/card-6.jpg',6),
    (v_id,'–ß–µ—Ä–Ω–æ–µ –∑–µ—Ä–∫–∞–ª–æ','/images/subcategories/entertainment-series/card-7.jpg',7),
    (v_id,'–¢–µ–æ—Ä–∏—è –±–æ–ª—å—à–æ–≥–æ –≤–∑—Ä—ã–≤–∞','/images/subcategories/entertainment-series/card-8.jpg',8),
    (v_id,'–ö–æ—Ä–æ–Ω–∞','/images/subcategories/entertainment-series/card-9.jpg',9),
    (v_id,'–ú–∞–Ω–¥–∞–ª–æ—Ä–µ—Ü','/images/subcategories/entertainment-series/card-10.jpg',10),
    (v_id,'–í–µ–¥—å–º–∞–∫','/images/subcategories/entertainment-series/card-11.jpg',11),
    (v_id,'–ë—É–º–∞–∂–Ω—ã–π –¥–æ–º','/images/subcategories/entertainment-series/card-12.jpg',12),
    (v_id,'–†–∏–≤–µ—Ä–¥–µ–π–ª','/images/subcategories/entertainment-series/card-13.jpg',13),
    (v_id,'–í–∏–∫–∏–Ω–≥–∏','/images/subcategories/entertainment-series/card-14.jpg',14),
    (v_id,'–ö–∞—Ä—Ç–æ—á–Ω—ã–π –¥–æ–º–∏–∫','/images/subcategories/entertainment-series/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –°–µ—Ä–∏–∞–ª: 15';
  END IF;

  -- 2.6 –õ—é–±–∏–º–∞—è –∏–≥—Ä–∞ (–Ω–∞—Å—Ç–æ–ª—å–Ω–∞—è / –≤–∏–¥–µ–æ–∏–≥—Ä–∞)
  SELECT id INTO v_id FROM subcategories WHERE name='–õ—é–±–∏–º–∞—è –∏–≥—Ä–∞ (–Ω–∞—Å—Ç–æ–ª—å–Ω–∞—è / –≤–∏–¥–µ–æ–∏–≥—Ä–∞)' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ú–æ–Ω–æ–ø–æ–ª–∏—è','/images/subcategories/entertainment-favorite-game/card-1.jpg',1),
    (v_id,'–®–∞—Ö–º–∞—Ç—ã','/images/subcategories/entertainment-favorite-game/card-2.jpg',2),
    (v_id,'–ú–∞—Ñ–∏—è','/images/subcategories/entertainment-favorite-game/card-3.jpg',3),
    (v_id,'GTA','/images/subcategories/entertainment-favorite-game/card-4.jpg',4),
    (v_id,'FIFA','/images/subcategories/entertainment-favorite-game/card-5.jpg',5),
    (v_id,'Minecraft','/images/subcategories/entertainment-favorite-game/card-6.jpg',6),
    (v_id,'The Witcher','/images/subcategories/entertainment-favorite-game/card-7.jpg',7),
    (v_id,'CS:GO','/images/subcategories/entertainment-favorite-game/card-8.jpg',8),
    (v_id,'–ü–æ–∫–µ—Ä','/images/subcategories/entertainment-favorite-game/card-9.jpg',9),
    (v_id,'Dota 2','/images/subcategories/entertainment-favorite-game/card-10.jpg',10),
    (v_id,'–ö–∞—Ä–∫–∞—Å—Å–æ–Ω','/images/subcategories/entertainment-favorite-game/card-11.jpg',11),
    (v_id,'Uno','/images/subcategories/entertainment-favorite-game/card-12.jpg',12),
    (v_id,'–°–∫—Ä–∞–±–ª','/images/subcategories/entertainment-favorite-game/card-13.jpg',13),
    (v_id,'Resident Evil','/images/subcategories/entertainment-favorite-game/card-14.jpg',14),
    (v_id,'Red Dead Redemption','/images/subcategories/entertainment-favorite-game/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –õ—é–±–∏–º–∞—è –∏–≥—Ä–∞: 15';
  END IF;

  -- 2.7 –°–∞–º—ã–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π —Ñ–∏–ª—å–º
  SELECT id INTO v_id FROM subcategories WHERE name='–°–∞–º—ã–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π —Ñ–∏–ª—å–º' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–í –ø–æ–≥–æ–Ω–µ –∑–∞ —Å—á–∞—Å—Ç—å–µ–º','/images/subcategories/entertainment-inspiring-movie/card-1.jpg',1),
    (v_id,'–û–±—â–µ—Å—Ç–≤–æ –º–µ—Ä—Ç–≤—ã—Ö –ø–æ—ç—Ç–æ–≤','/images/subcategories/entertainment-inspiring-movie/card-2.jpg',2),
    (v_id,'–ö–æ—Ä–æ–ª—å –≥–æ–≤–æ—Ä–∏—Ç','/images/subcategories/entertainment-inspiring-movie/card-3.jpg',3),
    (v_id,'–í—Å–µ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏ ¬´–î–∞¬ª','/images/subcategories/entertainment-inspiring-movie/card-4.jpg',4),
    (v_id,'127 —á–∞—Å–æ–≤','/images/subcategories/entertainment-inspiring-movie/card-5.jpg',5),
    (v_id,'–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ','/images/subcategories/entertainment-inspiring-movie/card-6.jpg',6),
    (v_id,'–ê–≤–≥—É—Å—Ç –†–∞—à','/images/subcategories/entertainment-inspiring-movie/card-7.jpg',7),
    (v_id,'–ñ–∏–∑–Ω—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞','/images/subcategories/entertainment-inspiring-movie/card-8.jpg',8),
    (v_id,'–†–æ–∫–∫–∏','/images/subcategories/entertainment-inspiring-movie/card-9.jpg',9),
    (v_id,'–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å','/images/subcategories/entertainment-inspiring-movie/card-10.jpg',10),
    (v_id,'–ë–∏–ª–ª–∏ –≠–ª–ª–∏–æ—Ç','/images/subcategories/entertainment-inspiring-movie/card-11.jpg',11),
    (v_id,'–ú–∞–ª—ã—à–∫–∞ –Ω–∞ –º–∏–ª–ª–∏–æ–Ω','/images/subcategories/entertainment-inspiring-movie/card-12.jpg',12),
    (v_id,'–î–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ –Ω–µ–±–µ—Å','/images/subcategories/entertainment-inspiring-movie/card-13.jpg',13),
    (v_id,'–û–¥–∞—Ä–µ–Ω–Ω–∞—è','/images/subcategories/entertainment-inspiring-movie/card-14.jpg',14),
    (v_id,'–ò–≥—Ä—ã —Ä–∞–∑—É–º–∞','/images/subcategories/entertainment-inspiring-movie/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π —Ñ–∏–ª—å–º: 15';
  END IF;

  RAISE NOTICE 'üé¨ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞: 105 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ';
END $$;

-- Part 3: –ñ–∏–≤–æ—Ç–Ω—ã–µ (60 –≤–æ–ø—Ä–æ—Å–æ–≤)
DO $$ 
DECLARE v_id UUID;
BEGIN
  -- 3.1 –õ—é–±–∏–º–∞—è –ø–æ—Ä–æ–¥–∞ —Å–æ–±–∞–∫
  SELECT id INTO v_id FROM subcategories WHERE name='–õ—é–±–∏–º–∞—è –ø–æ—Ä–æ–¥–∞ —Å–æ–±–∞–∫' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–õ–∞–±—Ä–∞–¥–æ—Ä','/images/subcategories/animals-dog-breed/card-1.jpg',1),
    (v_id,'–•–∞—Å–∫–∏','/images/subcategories/animals-dog-breed/card-2.jpg',2),
    (v_id,'–ù–µ–º–µ—Ü–∫–∞—è –æ–≤—á–∞—Ä–∫–∞','/images/subcategories/animals-dog-breed/card-3.jpg',3),
    (v_id,'–ó–æ–ª–æ—Ç–∏—Å—Ç—ã–π —Ä–µ—Ç—Ä–∏–≤–µ—Ä','/images/subcategories/animals-dog-breed/card-4.jpg',4),
    (v_id,'–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –±—É–ª—å–¥–æ–≥','/images/subcategories/animals-dog-breed/card-5.jpg',5),
    (v_id,'–ö–æ—Ä–≥–∏','/images/subcategories/animals-dog-breed/card-6.jpg',6),
    (v_id,'–®–ø–∏—Ü','/images/subcategories/animals-dog-breed/card-7.jpg',7),
    (v_id,'–ë–∏–≥–ª—å','/images/subcategories/animals-dog-breed/card-8.jpg',8),
    (v_id,'–î–∂–µ–∫-—Ä–∞—Å—Å–µ–ª —Ç–µ—Ä—å–µ—Ä','/images/subcategories/animals-dog-breed/card-9.jpg',9),
    (v_id,'–ô–æ—Ä–∫—à–∏—Ä—Å–∫–∏–π —Ç–µ—Ä—å–µ—Ä','/images/subcategories/animals-dog-breed/card-10.jpg',10),
    (v_id,'–î–æ–±–µ—Ä–º–∞–Ω','/images/subcategories/animals-dog-breed/card-11.jpg',11),
    (v_id,'–ß–∏—Ö—É–∞—Ö—É–∞','/images/subcategories/animals-dog-breed/card-12.jpg',12),
    (v_id,'–°–∞–º–æ–µ–¥','/images/subcategories/animals-dog-breed/card-13.jpg',13),
    (v_id,'–ë–æ—Ä–¥–µ—Ä-–∫–æ–ª–ª–∏','/images/subcategories/animals-dog-breed/card-14.jpg',14),
    (v_id,'–ú–æ–ø—Å','/images/subcategories/animals-dog-breed/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –õ—é–±–∏–º–∞—è –ø–æ—Ä–æ–¥–∞ —Å–æ–±–∞–∫: 15';
  END IF;

  -- 3.2 –ö–æ—à–∫–∏ vs —Å–æ–±–∞–∫–∏
  SELECT id INTO v_id FROM subcategories WHERE name='–ö–æ—à–∫–∏ vs —Å–æ–±–∞–∫–∏' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ò–≥—Ä–∏–≤—ã–π –∫–æ—Ç–µ–Ω–æ–∫','/images/subcategories/animals-cats-vs-dogs/card-1.jpg',1),
    (v_id,'–ü—Ä–µ–¥–∞–Ω–Ω—ã–π –ø–µ—Å','/images/subcategories/animals-cats-vs-dogs/card-2.jpg',2),
    (v_id,'–ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è –∫–æ—à–∫–∞','/images/subcategories/animals-cats-vs-dogs/card-3.jpg',3),
    (v_id,'–≠–Ω–µ—Ä–≥–∏—á–Ω—ã–π —â–µ–Ω–æ–∫','/images/subcategories/animals-cats-vs-dogs/card-4.jpg',4),
    (v_id,'–õ–µ–Ω–∏–≤—ã–π –∫–æ—Ç','/images/subcategories/animals-cats-vs-dogs/card-5.jpg',5),
    (v_id,'–û—Ö—Ä–∞–Ω–Ω—ã–π –ø–µ—Å','/images/subcategories/animals-cats-vs-dogs/card-6.jpg',6),
    (v_id,'–ì—Ä–∞—Ü–∏–æ–∑–Ω–∞—è –∫–æ—à–∫–∞','/images/subcategories/animals-cats-vs-dogs/card-7.jpg',7),
    (v_id,'–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–µ—Å','/images/subcategories/animals-cats-vs-dogs/card-8.jpg',8),
    (v_id,'–õ—é–±–æ–ø—ã—Ç–Ω—ã–π –∫–æ—Ç','/images/subcategories/animals-cats-vs-dogs/card-9.jpg',9),
    (v_id,'–û–±—É—á–∞–µ–º–∞—è —Å–æ–±–∞–∫–∞','/images/subcategories/animals-cats-vs-dogs/card-10.jpg',10),
    (v_id,'–ß–∏—Å—Ç–æ–ø–ª–æ—Ç–Ω–∞—è –∫–æ—à–∫–∞','/images/subcategories/animals-cats-vs-dogs/card-11.jpg',11),
    (v_id,'–ê–∫—Ç–∏–≤–Ω–∞—è —Å–æ–±–∞–∫–∞','/images/subcategories/animals-cats-vs-dogs/card-12.jpg',12),
    (v_id,'–ù–æ—á–Ω–æ–π –∫–æ—Ç','/images/subcategories/animals-cats-vs-dogs/card-13.jpg',13),
    (v_id,'–î–Ω–µ–≤–Ω–∞—è —Å–æ–±–∞–∫–∞','/images/subcategories/animals-cats-vs-dogs/card-14.jpg',14),
    (v_id,'–û–±–∞ —Ö–æ—Ä–æ—à–∏!','/images/subcategories/animals-cats-vs-dogs/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –ö–æ—à–∫–∏ vs —Å–æ–±–∞–∫–∏: 15';
  END IF;

  -- 3.3 –ò–¥–µ–∞–ª—å–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü
  SELECT id INTO v_id FROM subcategories WHERE name='–ò–¥–µ–∞–ª—å–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–°–æ–±–∞–∫–∞','/images/subcategories/animals-ideal-pet/card-1.jpg',1),
    (v_id,'–ö–æ—à–∫–∞','/images/subcategories/animals-ideal-pet/card-2.jpg',2),
    (v_id,'–ü–æ–ø—É–≥–∞–π','/images/subcategories/animals-ideal-pet/card-3.jpg',3),
    (v_id,'–•–æ–º—è–∫','/images/subcategories/animals-ideal-pet/card-4.jpg',4),
    (v_id,'–ö—Ä–æ–ª–∏–∫','/images/subcategories/animals-ideal-pet/card-5.jpg',5),
    (v_id,'–ê–∫–≤–∞—Ä–∏—É–º–Ω—ã–µ —Ä—ã–±–∫–∏','/images/subcategories/animals-ideal-pet/card-6.jpg',6),
    (v_id,'–ú–æ—Ä—Å–∫–∞—è —Å–≤–∏–Ω–∫–∞','/images/subcategories/animals-ideal-pet/card-7.jpg',7),
    (v_id,'–ß–µ—Ä–µ–ø–∞—Ö–∞','/images/subcategories/animals-ideal-pet/card-8.jpg',8),
    (v_id,'–ö—Ä—ã—Å–∞','/images/subcategories/animals-ideal-pet/card-9.jpg',9),
    (v_id,'–®–∏–Ω—à–∏–ª–ª–∞','/images/subcategories/animals-ideal-pet/card-10.jpg',10),
    (v_id,'–Å–∂','/images/subcategories/animals-ideal-pet/card-11.jpg',11),
    (v_id,'–ó–º–µ—è','/images/subcategories/animals-ideal-pet/card-12.jpg',12),
    (v_id,'–ò–≥—É–∞–Ω–∞','/images/subcategories/animals-ideal-pet/card-13.jpg',13),
    (v_id,'–•–æ—Ä–µ–∫','/images/subcategories/animals-ideal-pet/card-14.jpg',14),
    (v_id,'–°–∞—Ö–∞—Ä–Ω—ã–π –ø–æ—Å—Å—É–º','/images/subcategories/animals-ideal-pet/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –ò–¥–µ–∞–ª—å–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü: 15';
  END IF;

  -- 3.4 –î–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞ –∏–ª–∏ –¥–æ–º–∞—à–Ω–∏–µ –ª—é–±–∏–º—Ü—ã
  SELECT id INTO v_id FROM subcategories WHERE name='–î–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞ –∏–ª–∏ –¥–æ–º–∞—à–Ω–∏–µ –ª—é–±–∏–º—Ü—ã' LIMIT 1;
  IF v_id IS NOT NULL THEN
    INSERT INTO questions(subcategory_id,text,image_url,order_index) VALUES
    (v_id,'–ê—Ñ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –ª–µ–≤','/images/subcategories/animals-wildlife/card-1.jpg',1),
    (v_id,'–î–æ–º–∞—à–Ω—è—è –∫–æ—à–∫–∞','/images/subcategories/animals-wildlife/card-2.jpg',2),
    (v_id,'–í–æ–ª–∫','/images/subcategories/animals-wildlife/card-3.jpg',3),
    (v_id,'–î–æ–º–∞—à–Ω—è—è —Å–æ–±–∞–∫–∞','/images/subcategories/animals-wildlife/card-4.jpg',4),
    (v_id,'–°–ª–æ–Ω','/images/subcategories/animals-wildlife/card-5.jpg',5),
    (v_id,'–ú–æ—Ä—Å–∫–∏–µ —Å–≤–∏–Ω–∫–∏','/images/subcategories/animals-wildlife/card-6.jpg',6),
    (v_id,'–¢–∏–≥—Ä','/images/subcategories/animals-wildlife/card-7.jpg',7),
    (v_id,'–ö–∞–Ω–∞—Ä–µ–π–∫–∞','/images/subcategories/animals-wildlife/card-8.jpg',8),
    (v_id,'–î–µ–ª—å—Ñ–∏–Ω','/images/subcategories/animals-wildlife/card-9.jpg',9),
    (v_id,'–ê–∫–≤–∞—Ä–∏—É–º–Ω—ã–µ —Ä—ã–±–∫–∏','/images/subcategories/animals-wildlife/card-10.jpg',10),
    (v_id,'–ü–∞–Ω–¥–∞','/images/subcategories/animals-wildlife/card-11.jpg',11),
    (v_id,'–•–æ–º—è–∫','/images/subcategories/animals-wildlife/card-12.jpg',12),
    (v_id,'–ñ–∏—Ä–∞—Ñ','/images/subcategories/animals-wildlife/card-13.jpg',13),
    (v_id,'–ö—Ä–æ–ª–∏–∫','/images/subcategories/animals-wildlife/card-14.jpg',14),
    (v_id,'–û–±–∞ –º–∏—Ä–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã','/images/subcategories/animals-wildlife/card-15.jpg',15)
    ON CONFLICT DO NOTHING;
    RAISE NOTICE '‚úÖ –î–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞: 15';
  END IF;

  RAISE NOTICE 'üê∂ –ñ–∏–≤–æ—Ç–Ω—ã–µ: 60 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ';
END $$;