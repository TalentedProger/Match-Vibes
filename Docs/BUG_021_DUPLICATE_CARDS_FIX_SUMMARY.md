# BUG-021: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∏–≥—Ä–µ - –ò–°–ü–†–ê–í–õ–ï–ù–û

**–î–∞—Ç–∞:** 2025-11-13  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

---

## üìã –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–°–∏–º–ø—Ç–æ–º—ã:**

- –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: 15 –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
- –í –∏–≥—Ä–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è: 30 –∫–∞—Ä—Ç–æ—á–µ–∫ (–∫–∞–∂–¥–∞—è –ø–æ 2 —Ä–∞–∑–∞)
- –ò–≥—Ä–∞ –¥–ª–∏—Ç—Å—è –≤ 2 —Ä–∞–∑–∞ –¥–æ–ª—å—à–µ –ø–æ–ª–æ–∂–µ–Ω–Ω–æ–≥–æ

**–†–ï–ê–õ–¨–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:**
üö® **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö** –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –º–∏–≥—Ä–∞—Ü–∏–π, –∞ –ù–ï –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞!

**–î–µ—Ç–∞–ª–∏:**

- –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è subcategories –≤—ã–ø–æ–ª–Ω—è–ª—Å—è 2 —Ä–∞–∑–∞ (–¥—É–±–ª–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π)
- 75 —Å—Ç–∞—Ä—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ë–ï–ó subcategory_id + —Å–æ—Ç–Ω–∏ –Ω–æ–≤—ã—Ö –° subcategory_id
- API –≤–æ–∑–≤—Ä–∞—â–∞–ª –í–°–ï –≤–æ–ø—Ä–æ—Å—ã ‚Üí –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ 2+ —Ä–∞–∑–∞

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **üö® –ì–õ–ê–í–ù–û–ï: –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

**–§–∞–π–ª:** `Docs/CRITICAL_FIX_DUPLICATES_FINAL.sql`

```sql
-- –£–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã –±–µ–∑ subcategory_id (75 —à—Ç—É–∫)
DELETE FROM questions WHERE subcategory_id IS NULL AND is_active = true;

-- –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
WITH duplicates_cte AS (
  SELECT id, ROW_NUMBER() OVER (
    PARTITION BY category_id, name
    ORDER BY created_at ASC, id
  ) as row_num FROM subcategories
)
DELETE FROM subcategories
WHERE id IN (SELECT id FROM duplicates_cte WHERE row_num > 1);

-- –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
CREATE UNIQUE INDEX idx_questions_unique_active
ON questions(subcategory_id, text)
WHERE is_active = true AND subcategory_id IS NOT NULL;
```

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω game-store.ts (–≤—Ç–æ—Ä–∏—á–Ω–æ)**

```typescript
// –î–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û)
partialize: state => ({
  roomId: state.roomId,
  categoryId: state.categoryId,
  currentQuestionIndex: state.currentQuestionIndex,
  responses: state.responses,
  // questions –ù–ï –°–û–•–†–ê–ù–Ø–õ–ò–°–¨!
})

// –ü–û–°–õ–ï (–ü–†–ê–í–ò–õ–¨–ù–û)
partialize: state => ({
  roomId: state.roomId,
  categoryId: state.categoryId,
  questions: state.questions, // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
  currentQuestionIndex: state.currentQuestionIndex,
  responses: state.responses,
})
```

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**

```typescript
// Prevent re-fetching if we already have questions
if (questions.length > 0 && roomId === currentRoom.id) {
  console.log('Questions already loaded, skipping fetch')
  return
}
```

### 3. **–°–æ–∑–¥–∞–Ω useGameManager —Ö—É–∫**

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–º–Ω–∞—Ç
- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–º–µ—à–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–Ω—ã—Ö –∏–≥—Ä

### 4. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

```typescript
console.log('Raw questions from API:', data.questions.length)
console.log('Unique questions after filtering:', uniqueQuestions.length)
```

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

**üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö):**

- ‚úÖ `Docs/CRITICAL_FIX_DUPLICATES_FINAL.sql` - **–ì–õ–ê–í–ù–û–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ë–î**
- ‚úÖ `Docs/check_questions_duplicates.sql` - SQL –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**–í–¢–û–†–ò–ß–ù–´–ï (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥):**

- ‚úÖ `src/stores/game-store.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ persist –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ `src/app/(main)/game/[roomId]/page.tsx` - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ `src/hooks/use-game-manager.ts` - –Ω–æ–≤—ã–π —Ö—É–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- ‚úÖ `Docs/Bug_tracking.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ë–î:**

- ‚úÖ –í –∫–∞–∂–¥–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ **—Ä–æ–≤–Ω–æ 15 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤**
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã **–í–°–ï –¥—É–±–ª–∏–∫–∞—Ç—ã** (—Å—Ç–∞—Ä—ã–µ + –Ω–æ–≤—ã–µ)
- ‚úÖ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤**
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã **–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –¥—É–±–ª–∏**

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**

- ‚úÖ –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **—Ä–æ–≤–Ω–æ 1 —Ä–∞–∑**
- ‚úÖ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ **15 –≤–æ–ø—Ä–æ—Å–æ–≤** (–∫–∞–∫ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–º–Ω–∞—Ç
- ‚úÖ localStorage —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üöÄ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 1. **üö® –ì–õ–ê–í–ù–û–ï: –ó–∞–ø—É—Å—Ç–∏—Ç—å SQL –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**

```sql
-- –í Supabase SQL Editor:
-- –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–µ—Å—å —Ñ–∞–π–ª:
Docs/CRITICAL_FIX_DUPLICATES_FINAL.sql
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ë–î

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:
SELECT
  c.name || ' ' || c.icon as category,
  sc.name as subcategory,
  COUNT(q.id) as questions_count
FROM categories c
LEFT JOIN subcategories sc ON sc.category_id = c.id
LEFT JOIN questions q ON q.subcategory_id = sc.id AND q.is_active = true
WHERE c.is_active = true AND sc.is_active = true
GROUP BY c.id, c.name, c.icon, sc.id, sc.name
ORDER BY c.order_index, sc.order_index;
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä—É

–¢–µ–ø–µ—Ä—å –∫–∞–∂–¥–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 15 –≤–æ–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –¥—É–±–ª–µ–π.

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–≥—Ä—ã (–≤—Ç–æ—Ä–∏—á–Ω–æ)

–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:

- "Raw questions from API:" - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
- "Unique questions after filtering:" - –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

---

## üõ°Ô∏è –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º

**üö® –ë–ê–ó–ê –î–ê–ù–ù–´–• (–∫—Ä–∏—Ç–∏—á–Ω–æ):**

- –°–æ–∑–¥–∞–≤–∞—Ç—å **—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ü–ï–†–ï–î** –≤—Å—Ç–∞–≤–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
- **–ù–ï –≤—ã–ø–æ–ª–Ω—è—Ç—å** –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–∫—Ä–∏–ø—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ON CONFLICT DO NOTHING` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ constraints
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–ø–∏–∏ –ø—Ä–æ–¥–∞–∫—à–Ω –¥–∞–Ω–Ω—ã—Ö

**–§–†–û–ù–¢–ï–ù–î (–≤—Ç–æ—Ä–∏—á–Ω–æ):**

- –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞—Ç—å **–í–°–ï** –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –≤ persist `partialize`
- –î–æ–±–∞–≤–ª—è—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ `useEffect`
- –û—á–∏—â–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

**‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê**

üéØ **–ì–ª–∞–≤–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ:** –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –ù–ï –≤ –∫–æ–¥–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, –∞ –≤ **–±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**!

–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ:

- üóÑÔ∏è **–ù–∞ —É—Ä–æ–≤–Ω–µ –ë–î:** –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ –¥—É–±–ª–∏, —Å–æ–∑–¥–∞–Ω—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- üíª **–ù–∞ —É—Ä–æ–≤–Ω–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:** –£–ª—É—á—à–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Zustand –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- üéÆ **–ù–∞ —É—Ä–æ–≤–Ω–µ –∏–≥—Ä—ã:** –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑
