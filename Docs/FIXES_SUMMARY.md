# Fixes Summary - –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

**–î–∞—Ç–∞:** 2025-01-09  
**–ü—Ä–æ–±–ª–µ–º—ã:** SQL –º–∏–≥—Ä–∞—Ü–∏—è + Webhook –±–æ—Ç–∞

---

## üîß –ü—Ä–æ–±–ª–µ–º–∞ 1: SQL –º–∏–≥—Ä–∞—Ü–∏—è

### –û—à–∏–±–∫–∏:

```
ERROR: policy "Subcategories are viewable by everyone" already exists
```

- –°–æ–∑–¥–∞—ë—Ç—Å—è –±–æ–ª—å—à–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —á–µ–º –Ω—É–∂–Ω–æ
- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–µ –≤–æ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö

### ‚úÖ –†–µ—à–µ–Ω–∏–µ:

–§–∞–π–ª `Docs/subcategories_migration.sql` **–æ–±–Ω–æ–≤–ª—ë–Ω**:

- –î–æ–±–∞–≤–ª–µ–Ω `DROP POLICY IF EXISTS`
- –ù–ï —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ç–æ–ª—å–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π

### –î–µ–π—Å—Ç–≤–∏—è:

1. **–û—á–∏—Å—Ç–∏—Ç–µ –¥—É–±–ª–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å):**

```sql
-- –í Supabase SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
DROP TABLE IF EXISTS subcategories CASCADE;

DELETE FROM categories
WHERE id NOT IN (
  SELECT MIN(id)
  FROM categories
  GROUP BY icon
);
```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ Supabase ‚Üí SQL Editor
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–≤–µ—Å—å** –∫–æ–¥ –∏–∑ `Docs/subcategories_migration.sql`
   - –ù–∞–∂–º–∏—Ç–µ **Run**

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**

```sql
SELECT COUNT(*) FROM subcategories;
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 34 –∏–ª–∏ –º–µ–Ω—å—à–µ

SELECT
  c.icon,
  c.name,
  COUNT(sc.id) as count
FROM categories c
LEFT JOIN subcategories sc ON sc.category_id = c.id
GROUP BY c.id, c.icon, c.name
ORDER BY c.order_index;
```

---

## ü§ñ –ü—Ä–æ–±–ª–µ–º–∞ 2: Webhook –±–æ—Ç–∞

### –û—à–∏–±–∫–∞:

```
üìç Webhook URL: https://matchvibesmain.vercel.app//api/bot/webhook
                                                     ^^
Bad Request: secret token contains unallowed characters
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ:

–§–∞–π–ª `scripts/set-webhook.ts` **–æ–±–Ω–æ–≤–ª—ë–Ω**:

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –¥–≤–æ–π–Ω–æ–π —Å–ª—ç—à –∏–∑ URL
- –£–±—Ä–∞–Ω `secret_token` (–≤—ã–∑—ã–≤–∞–ª –æ—à–∏–±–∫—É)

### –î–µ–π—Å—Ç–≤–∏—è:

1. **–û–±–Ω–æ–≤–∏—Ç–µ `.env.local`:**

```env
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ù–ï–¢ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–ª—ç—à–∞:
NEXT_PUBLIC_APP_URL=https://matchvibesmain.vercel.app

# –£–¥–∞–ª–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å):
# TELEGRAM_WEBHOOK_SECRET=...
```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ webhook setup:**

```bash
pnpm bot:webhook
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
üîß Setting Telegram webhook...
üìç Webhook URL: https://matchvibesmain.vercel.app/api/bot/webhook
‚úÖ Webhook set successfully!
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

---

## üìã –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç

### SQL –º–∏–≥—Ä–∞—Ü–∏—è:

- [ ] –û—á–∏—Å—Ç–∏–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- [ ] –ó–∞–ø—É—Å—Ç–∏–ª–∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `subcategories_migration.sql`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ~34)
- [ ] –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è

### Webhook –±–æ—Ç–∞:

- [ ] –û–±–Ω–æ–≤–∏–ª–∏ `.env.local` (—É–±—Ä–∞–ª–∏ `/` –≤ –∫–æ–Ω—Ü–µ URL)
- [ ] –£–¥–∞–ª–∏–ª–∏ `TELEGRAM_WEBHOOK_SECRET` –∏–∑ `.env.local`
- [ ] –ó–∞–ø—É—Å—Ç–∏–ª–∏ `pnpm bot:webhook` —É—Å–ø–µ—à–Ω–æ
- [ ] –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –≤ Telegram

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤:

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:

‚úÖ 5-7 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)  
‚úÖ ~34 –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º  
‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/categories` —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/categories/[id]` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏

### –ë–æ—Ç:

‚úÖ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ Vercel  
‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–ë–ï–ó –∫–æ–º–∞–Ω–¥—ã `pnpm bot:dev`)  
‚úÖ –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ  
‚úÖ –ù–µ –Ω—É–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç—ã–º

---

## üöÄ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### Production (Vercel):

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É
2. Telegram ‚Üí POST –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/bot/webhook
3. Vercel –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ API route
4. API route ‚Üí bot.handleUpdate()
5. –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –æ—Ç–≤–µ—á–∞–µ—Ç
```

**–í—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** –ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–∞–Ω–¥ –Ω–µ –Ω—É–∂–Ω–æ.

### Development (Local):

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –¢–æ–ª—å–∫–æ Next.js
pnpm dev

# –í–∞—Ä–∏–∞–Ω—Ç 2: Next.js + Bot
pnpm dev:all
```

---

## üìö –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **`Docs/SQL_Migration_Fix.md`** - –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ SQL –º–∏–≥—Ä–∞—Ü–∏—é
- **`Docs/Webhook_Fix_Instructions.md`** - –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ webhook
- **`Docs/Bot_Server_Setup.md`** - –∫–∞–∫ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- **`Docs/QUICKSTART_v2.md`** - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

---

## ‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**Q: –ù—É–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å `pnpm bot:dev` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ?**  
A: **–ù–ï–¢!** –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ webhook –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**Q: –ö–∞–∫ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏ —è –Ω–µ –∑–∞–ø—É—Å–∫–∞—é –∫–æ–º–∞–Ω–¥—ã?**  
A: Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ `/api/bot/webhook` –æ—Ç Telegram.

**Q: –ù—É–∂–Ω–æ –ª–∏ –¥–µ—Ä–∂–∞—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç—ã–º?**  
A: **–ù–ï–¢!** Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞, –ø–æ–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–¥–µ–ø–ª–æ–µ–Ω–æ.

**Q: –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω `pnpm bot:webhook`?**  
A: –¢–æ–ª—å–∫–æ **–æ–¥–∏–Ω —Ä–∞–∑** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω.

**Q: –ü–æ—á–µ–º—É –ª–æ–∫–∞–ª—å–Ω–æ –Ω—É–∂–µ–Ω `pnpm dev:bot`?**  
A: Webhook —Ç—Ä–µ–±—É–µ—Ç HTTPS, localhost –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HTTP. –ü–æ—ç—Ç–æ–º—É –ª–æ–∫–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling.

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–û–±–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã:

1. ‚úÖ SQL –º–∏–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. ‚úÖ Webhook –±–æ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
3. ‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
4. ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è
5. ‚úÖ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~5 –º–∏–Ω—É—Ç  
**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ
