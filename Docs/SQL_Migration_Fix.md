# SQL Migration Fix - –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º `subcategories_migration.sql`.

---

## –ü—Ä–æ–±–ª–µ–º—ã –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏:

1. ‚ùå "Policy already exists" - –ø–æ–ª–∏—Ç–∏–∫–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞
2. ‚ùå –°–æ–∑–¥–∞—ë—Ç—Å—è –±–æ–ª—å—à–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —á–µ–º –Ω—É–∂–Ω–æ
3. ‚ùå –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–µ –≤–æ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö

---

## ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–∞!

–§–∞–π–ª `Docs/subcategories_migration.sql` –æ–±–Ω–æ–≤–ª—ë–Ω –∏ —Ç–µ–ø–µ—Ä—å:

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `DROP POLICY IF EXISTS` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏
2. ‚úÖ –ù–ï —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ç–æ–ª—å–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
3. ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞–π–¥–µ–Ω–∞
4. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

---

## –ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –≤—ã —É–∂–µ –∑–∞–ø—É—Å–∫–∞–ª–∏ —Å—Ç–∞—Ä—ã–π —Å–∫—Ä–∏–ø—Ç –∏ —É –≤–∞—Å –¥—É–±–ª–∏–∫–∞—Ç—ã:

```sql
-- –£–¥–∞–ª–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–Ω–æ–≤–æ
DROP TABLE IF EXISTS subcategories CASCADE;

-- –£–¥–∞–ª–∏—Ç–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–æ—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ)
DELETE FROM categories
WHERE id NOT IN (
  SELECT MIN(id)
  FROM categories
  GROUP BY icon
);
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase ‚Üí SQL Editor
2. –°–æ–∑–¥–∞–π—Ç–µ **New query**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–í–ï–°–¨** –∫–æ–¥ –∏–∑ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ `Docs/subcategories_migration.sql`
4. –ù–∞–∂–º–∏—Ç–µ **Run**

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
NOTICE: ‚úÖ Food subcategories created
NOTICE: ‚úÖ Entertainment subcategories created
NOTICE: ‚úÖ Animals subcategories created
NOTICE: ‚úÖ Relationships subcategories created
NOTICE: ‚úÖ Leisure subcategories created
NOTICE: ‚úÖ Subcategories created successfully!
NOTICE: Total subcategories: 34
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
SELECT COUNT(*) FROM categories WHERE is_active = TRUE;
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 5 –∏–ª–∏ –º–µ–Ω—å—à–µ (—Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
SELECT COUNT(*) FROM subcategories;
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 34 (–∏–ª–∏ –º–µ–Ω—å—à–µ, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π)

-- –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
SELECT
  c.icon as emoji,
  c.name as category,
  COUNT(sc.id) as subcategories_count
FROM categories c
LEFT JOIN subcategories sc ON sc.category_id = c.id
GROUP BY c.id, c.icon, c.name, c.order_index
ORDER BY c.order_index;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
üçï | –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏            | 7
üé¨ | –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∫—É–ª—å—Ç—É—Ä–∞   | 7
üê∂ | –ñ–∏–≤–æ—Ç–Ω—ã–µ                 | 4
üíû | –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª–∏—á–Ω–æ—Å—Ç—å     | 6
üèñÔ∏è | –î–æ—Å—É–≥ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è      | 5
```

---

## –ï—Å–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ —Å–æ–∑–¥–∞–ª–∏—Å—å

### –ü—Ä–∏—á–∏–Ω–∞:

–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å –Ω—É–∂–Ω—ã–º emoji –∏–ª–∏ –∏–º–µ–Ω–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î.

### –†–µ—à–µ–Ω–∏–µ:

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤—Ä—É—á–Ω—É—é

```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å—Ç—å
SELECT id, name, icon FROM categories ORDER BY order_index;

-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ –µ—ë
-- –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è "–õ–∏—á–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ":
INSERT INTO categories (name, icon, description, order_index, is_active)
VALUES ('–õ–∏—á–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ', 'üí°', '–í–∞—à–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –º–∏—Ä–∞', 6, TRUE);

-- –î–ª—è "–†–∞–∑–Ω–æ–µ –∏ –≤–µ—Å—ë–ª–æ–µ":
INSERT INTO categories (name, icon, description, order_index, is_active)
VALUES ('–†–∞–∑–Ω–æ–µ –∏ –≤–µ—Å—ë–ª–æ–µ', 'üéÅ', '–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã', 7, TRUE);
```

–ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –∏–º–µ–Ω–∞–º–∏, –æ–±–Ω–æ–≤–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç:

1. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å—Ç—å:

```sql
SELECT id, name, icon FROM categories;
```

2. –ó–∞–º–µ–Ω–∏—Ç–µ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ –≤–∞—à–µ:

```sql
-- –ù–∞–ø—Ä–∏–º–µ—Ä, –≤–º–µ—Å—Ç–æ:
SELECT id INTO food_cat_id FROM categories WHERE icon = 'üçï' LIMIT 1;

-- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à–µ –∏–º—è:
SELECT id INTO food_cat_id FROM categories WHERE name = '–í–ê–®_–ù–ê–ó–í–ê–ù–ò–ï' LIMIT 1;
```

---

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### ‚úÖ –°–∫—Ä–∏–ø—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ —Ä–∞–∑ - –æ–Ω:

- –ù–µ —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ON CONFLICT DO NOTHING` –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö

### ‚úÖ –°–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

–ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:

```
WARNING: Food category not found! Please create it first.
```

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å.

### ‚úÖ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π:

```sql
IF food_cat_id IS NOT NULL THEN
  -- –≤—Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
END IF;
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –¢–µ—Å—Ç 1: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏

```sql
SELECT
  id,
  name,
  icon,
  order_index,
  is_active
FROM categories
ORDER BY order_index;
```

–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤!

### –¢–µ—Å—Ç 2: –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏

```sql
SELECT
  c.name as category,
  sc.name as subcategory,
  sc.order_index
FROM subcategories sc
JOIN categories c ON c.id = sc.category_id
ORDER BY c.order_index, sc.order_index;
```

–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.

### –¢–µ—Å—Ç 3: API —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# –ó–∞–º–µ–Ω–∏—Ç–µ CATEGORY_ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
curl http://localhost:3002/api/categories/{CATEGORY_ID}/subcategories
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π.

---

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### "Function public.update_updated_at_column has a role mutable search_path"

**–ß—Ç–æ —ç—Ç–æ:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏

**–û–ø–∞—Å–Ω–æ –ª–∏:** –ù–µ—Ç, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ù—É–∂–Ω–æ –ª–∏ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å:** –ù–µ—Ç, –º–æ–∂–Ω–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å

**–ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**

```sql
ALTER FUNCTION update_updated_at_column() SET search_path = '';
```

---

## –†–µ–∑—é–º–µ

**–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞:**

1. ‚úÖ `DROP POLICY IF EXISTS` - –Ω–µ—Ç –æ—à–∏–±–∫–∏ "already exists"
2. ‚úÖ –ò—â–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ emoji –∏ –∏–º–µ–Ω–∏ - –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
4. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
5. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã)
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
4. –ì–æ—Ç–æ–≤–æ! ‚úÖ

---

**SQL –º–∏–≥—Ä–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!** üéâ
