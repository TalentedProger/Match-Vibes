# Webhook Setup Fix - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π webhook –¥–ª—è Telegram –±–æ—Ç–∞.

---

## –ü—Ä–æ–±–ª–µ–º–∞ 1: Double slash –≤ URL ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### –ë—ã–ª–æ:

```
https://matchvibesmain.vercel.app//api/bot/webhook
                               ^^
                          –¥–≤–æ–π–Ω–æ–π —Å–ª—ç—à
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

–û–±–Ω–æ–≤–ª–µ–Ω `scripts/set-webhook.ts` - —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–ª—ç—à –∏–∑ URL.

---

## –ü—Ä–æ–±–ª–µ–º–∞ 2: Secret token error ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### –û—à–∏–±–∫–∞:

```
Bad Request: secret token contains unallowed characters
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

–£–±—Ä–∞–Ω `secret_token` –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ webhook. –î–ª—è production —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ Telegram –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç webhook —á–µ—Ä–µ–∑ HTTPS.

---

## –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env.local

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `.env.local` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–æ—Ç_BotFather
NEXT_PUBLIC_TELEGRAM_BOT_USERNAME=–≤–∞—à_–±–æ—Ç_–±–µ–∑_@

# App URL (–ë–ï–ó —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–ª—ç—à–∞!)
NEXT_PUBLIC_APP_URL=https://matchvibesmain.vercel.app
```

**–í–∞–∂–Ω–æ:**

- ‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π—Ç–µ `/` –≤ –∫–æ–Ω—Ü–µ URL
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: `https://matchvibesmain.vercel.app`
- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: `https://matchvibesmain.vercel.app/`

---

## –®–∞–≥ 2: –£–¥–∞–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫—É TELEGRAM_WEBHOOK_SECRET

–ï—Å–ª–∏ –≤ `.env.local` –µ—Å—Ç—å —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞, —É–¥–∞–ª–∏—Ç–µ –µ—ë:

```env
# –£–î–ê–õ–ò–¢–ï —ç—Ç—É —Å—Ç—Ä–æ–∫—É:
TELEGRAM_WEBHOOK_SECRET=...
```

–û–Ω–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏.

---

## –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook

### –õ–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):

```bash
pnpm bot:webhook
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
üîß Setting Telegram webhook...
üìç Webhook URL: https://matchvibesmain.vercel.app/api/bot/webhook
‚úÖ Webhook set successfully!
```

### –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ:

```json
{
  "ok": true,
  "result": true,
  "description": "Webhook was set"
}

üìä Getting webhook info...
‚úÖ Webhook info:
{
  "url": "https://matchvibesmain.vercel.app/api/bot/webhook",
  "has_custom_certificate": false,
  "pending_update_count": 0
}
```

---

## –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç

### –¢–µ—Å—Ç –≤ Telegram:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
3. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

### –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 1:** Webhook –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π?

```bash
curl "https://api.telegram.org/bot<–í–ê–®_–¢–û–ö–ï–ù>/getWebhookInfo"
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 2:** API route —Ä–∞–±–æ—Ç–∞–µ—Ç?

```bash
curl https://matchvibesmain.vercel.app/api/bot/webhook
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `405 Method Not Allowed` (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - endpoint –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ POST)

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 3:** –õ–æ–≥–∏ Vercel

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://vercel.com/
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
3. Functions ‚Üí `/api/bot/webhook`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

---

## –í–ê–ñ–ù–û: Webhook –Ω–∞ Vercel —Ä–∞–±–æ—Ç–∞–µ—Ç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–î–µ–ø–ª–æ–π –Ω–∞ Vercel** ‚Üí Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç endpoint `/api/bot/webhook`
2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook** ‚Üí `pnpm bot:webhook` (–æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)
3. **–ì–æ—Ç–æ–≤–æ!** ‚Üí –ë–æ—Ç —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –í–∞–º –ù–ï –Ω—É–∂–Ω–æ:

- ‚ùå –ó–∞–ø—É—Å–∫–∞—Ç—å `pnpm bot:dev` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- ‚ùå –î–µ—Ä–∂–∞—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç—ã–º
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
- ‚ùå –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å PM2 –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏

### –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ç–æ–º—É —á—Ç–æ:

- ‚úÖ Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ `/api/bot/webhook`
- ‚úÖ Vercel –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ Next.js API route
- ‚úÖ API route –≤—ã–∑—ã–≤–∞–µ—Ç `bot.handleUpdate()`
- ‚úÖ –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –∏ –æ—Ç–≤–µ—á–∞–µ—Ç

---

## Development vs Production

### Production (Vercel):

```
Telegram ‚Üí Webhook ‚Üí Vercel ‚Üí API Route ‚Üí Bot ‚Üí Response
```

- –†–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∫–æ–º–∞–Ω–¥
- Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ–¥–∏–Ω —Ä–∞–∑

### Development (Local):

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –¢–æ–ª—å–∫–æ Next.js (–±–µ–∑ –±–æ—Ç–∞)
pnpm dev

# –í–∞—Ä–∏–∞–Ω—Ç 2: Next.js + Bot (polling)
pnpm dev:all
```

**–ü–æ—á–µ–º—É –Ω—É–∂–µ–Ω `pnpm dev:all` –ª–æ–∫–∞–ª—å–Ω–æ?**

- Webhook —Ç—Ä–µ–±—É–µ—Ç HTTPS
- Localhost –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HTTP
- –ü–æ—ç—Ç–æ–º—É –ª–æ–∫–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling mode

---

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞ 1: "Webhook not found"

**–ü—Ä–∏—á–∏–Ω–∞:** Webhook –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**

```bash
pnpm bot:webhook
```

---

### –û—à–∏–±–∫–∞ 2: "Bad Request: wrong webhook url specified"

**–ü—Ä–∏—á–∏–Ω–∞:** URL –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `NEXT_PUBLIC_APP_URL` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
2. URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `https://`
3. URL –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `/`

---

### –û—à–∏–±–∫–∞ 3: "Bot not responding after webhook setup"

**–ü—Ä–∏—á–∏–Ω–∞:** Endpoint –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–∞–π–ª `src/app/api/bot/webhook/route.ts` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. Redeploy –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Vercel
3. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook: `pnpm bot:webhook`

---

### –û—à–∏–±–∫–∞ 4: "Conflict: another webhook is active"

**–ü—Ä–∏—á–∏–Ω–∞:** –°—Ç–∞—Ä—ã–π webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π webhook
curl -X POST "https://api.telegram.org/bot<–¢–û–ö–ï–ù>/deleteWebhook"

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π
pnpm bot:webhook
```

---

## –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤:

- [ ] `.env.local` –æ–±–Ω–æ–≤–ª–µ–Ω (–±–µ–∑ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ `/` –≤ URL)
- [ ] `TELEGRAM_WEBHOOK_SECRET` —É–¥–∞–ª–µ–Ω–∞ –∏–∑ `.env.local`
- [ ] `pnpm bot:webhook` –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] Webhook info –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
- [ ] –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ `/start` –≤ Telegram
- [ ] –ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–∞–Ω–¥ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
- [ ] –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## –†–µ–∑—é–º–µ

**–ß—Ç–æ –±—ã–ª–æ:**

- ‚ùå Double slash –≤ webhook URL
- ‚ùå Secret token —Å –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
- ‚ùå –ù–µ—è—Å–Ω–æ –∫–∞–∫ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ß—Ç–æ —Å—Ç–∞–ª–æ:**

- ‚úÖ URL –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π (–±–µ–∑ –¥–≤–æ–π–Ω–æ–≥–æ —Å–ª—ç—à–∞)
- ‚úÖ Secret token —É–¥–∞–ª—ë–Ω
- ‚úÖ Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ Vercel
- ‚úÖ –ù–µ –Ω—É–∂–Ω—ã –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ

**–°–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**

1. –û–±–Ω–æ–≤–∏—Ç–µ `.env.local`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `pnpm bot:webhook`
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
4. –ì–æ—Ç–æ–≤–æ! –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ üéâ

---

**–ë–æ—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** üöÄ
